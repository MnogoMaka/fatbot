import csv
import os
import logging
import calendar
import random
from dataclasses import dataclass
from datetime import date, datetime, timedelta, time as dtime
from enum import Enum
from pathlib import Path
from typing import Dict, List, Optional, Tuple, Set
from collections import defaultdict

import pytz
from matplotlib.patches import Rectangle, FancyBboxPatch
from dotenv import load_dotenv

load_dotenv()
import matplotlib

matplotlib.use("Agg")
import matplotlib.pyplot as plt

from telegram import (
    Update,
    ReplyKeyboardMarkup,
    ReplyKeyboardRemove,
    InputFile,
    InlineKeyboardMarkup,
    InlineKeyboardButton,
)
from telegram.ext import (
    ApplicationBuilder,
    CommandHandler,
    ConversationHandler,
    CallbackQueryHandler,
    MessageHandler,
    ContextTypes,
    filters,
)

# --- Конфигурация логгирования ---
logging.basicConfig(
    format='%(asctime)s - %(name)s - %(levelname)s - %(message)s',
    level=logging.INFO
)
logger = logging.getLogger(__name__)

# --- Конфигурация доступа и путей ---
ALLOWED_USERNAMES = {"ilyaqrc", "lookfmistakes"}

BASE_DIR = Path(__file__).parent
DATA_DIR = BASE_DIR / "data"
DATA_DIR.mkdir(exist_ok=True)

USERS_CSV = DATA_DIR / "users.csv"
ENTRIES_CSV = DATA_DIR / "entries.csv"
CALENDAR_DIR = DATA_DIR / "calendars"
CALENDAR_DIR.mkdir(exist_ok=True)

MOSCOW_TZ = pytz.timezone("Europe/Moscow")

# Небольшой список колких фраз — можно расширять
BAD_LIST: List[str] = [
    "Ну что, жиртрест, записал очередную подлянку для талии?",
    "Каждый лишний кусок — это ещё один шов на твоих штанах.",
    "Жир не плачет, жир просто тихо растёт. Следи за цифрами.",
    "Кормить внутреннего кабана мы уже закончили или ещё нет?",
    "Холодильник — не лучший друг, запомни это, пузатик.",
    "Жирок сам себя не сожжёт, ккалочку за ккалочкой давай сюда.",
    "Ты сейчас худеешь или снова репетируешь роль мягкого диванного биомассива?",
    "Каждый твоё «ну ладно, ещё кусочек» — это минус к уважению к себе.",
    "Твои отмазки сжигают ноль калорий, в отличие от тренировок.",
    "Живот растёт быстрее, чем твоя сила воли, не находишь?",
    "Ты ешь как чемпион, а двигаешься как памятник собственной лени.",
    "Весы уже боятся, когда ты к ним подходишь, тормозни немного.",
    "Твои штаны не малы, это ты слишком расслабился.",
    "Не диета у тебя строгая, а ты просто разгильдяй с вилкой.",
    "Каждый ночной жор — это голос твоей слабости, а не голода.",
    "Ты ешь не потому, что голоден, а потому что заскучал. Ленивая туша.",
    "С таким темпом обжорства твой пупок скоро встанет в статус опасного объекта.",
    "Ты не потолстел — ты накопил доказательства своей недисциплинированности.",
    "Хочешь кубики на животе? Сначала перестань строить из еды бетонную плиту.",
    "Твоё зеркало уже подаёт в отставку от того, что видит каждое утро.",
    "Это не одежда стала меньше, это твоя жратва стала больше.",
    "Каждый поход к холодильнику — это маленькое предательство будущей формы.",
    "Ты не заедешь стресс, ты просто вырастишь его себе на боках.",
    "Твой главный спорт сейчас — перекладывание еды из тарелки в рот.",
    "С таким отношением к еде тебе нужен не тренер, а пастух.",
    "Ты не толстый, ты просто слишком часто говоришь «а, потом разберусь».",
    "Пока ты жалеешь себя, твой жир чувствует себя отлично.",
    "Устал быть мягким? Перестань быть слабым у холодильника.",
    "Хочешь минус кило? Начни с минус десерт сегодня.",
    "Твой язык качает больше, чем всё тело: оправдания — твой единственный фитнес.",
    "Бока не наросли за один день, но ты честно вкладывался каждый ужин.",
    "Ты не «любишь поесть», ты просто боишься сказать себе «хватит».",
    "Каждый твой «с понедельника» уже давно прописался в жировых запасах.",
    "Еда тебе не друг, когда ты превращаешься в её склад.",
    "С таким аппетитом только холодильник считает тебя атлетом.",
    "Ты не голодный — ты зависимый от привычки всё время жевать.",
    "Если бы ты так же вкалывал в зале, как у стола, уже был бы рельефным.",
    "Жир на животе — это твой дневник, написанный вилкой и ложкой.",
    "Ты не худеешь не потому, что сложно, а потому что лень сильнее желания.",
    "Жвачка для тебя — это пауза между основными актами обжорства.",
    "Твой любимый спорт — добежать до холодильника и вернуться с трофеем.",
    "Каждый лишний укус — это голос за то, чтобы остаться в своём нынешнем тушечном формате.",
    "Ты не строишь тело, ты просто складируешь калории как хомяк на зиму.",
    "Хочешь результат — перестань кормить собственные отговорки.",
    "Эта булочка не стоит ещё одного дырявого ремня.",
    "Ты не «угощаешь себя», ты саботируешь свои же цели.",
    "Твой живот — это памятник всем «да ладно, один раз можно».",
    "Пока ты думаешь, жрать или не жрать, ты уже всё сожрал.",
    "Голод — это сигнал тела, а не фантазии твоей прожорливой головы.",
    "Каждый приём пищи без меры — ещё один шаг к тому, чтобы задохнуться, завязывая шнурки.",
    "Если тебе тяжело отказать себе в печеньке, не удивляйся тяжести в теле.",
    "Ты считаешь калории или продолжаешь играть в русскую рулетку с ремнём?",
    "Твоё отражение в лифтовом зеркале уже подаёт сигнал тревоги.",
    "Жир на боках не от волшебства, а от твоих вечерних вылазок на кухню.",
    "Ты не устаёшь от диеты, ты устаёшь от мысли перестать жрать всё подряд.",
    "Каждый перекус «между делом» — это прямо в копилку брюшка.",
    "Хочешь мотивацию? Посмотри на склад под майкой — вот он, твой прогресс.",
    "Устал задыхаться после пары лестничных пролётов? Пора устать и от булок.",
    "Ты не машина по сжиганию жира, ты пока что склад готовой продукции.",
    "Стресс не лечится печеньем, он просто прописывается у тебя на талии.",
    "Ты не толстый от генетики, ты толстый от привычек.",
    "Твоя ложка — главный враг твоего пресса.",
    "Проблема не в том, что ты ешь, а в том, что ты не можешь остановиться.",
    "Ты не на массе, ты просто на бесконечном перекусе.",
    "Каждый лайк на фотки худых — это плевок в сторону твоей тарелки, но ты всё равно жрёшь.",
    "Хочешь уважать себя — начни с уважения к собственному телу, а не к тортикам.",
    "Если ты так любишь еду, почему она так ненавидит твою фигуру?",
    "Твои «читмилы» давно стали обычным питанием ленивого прожоры.",
    "Сначала ты ешь, как будто завтра не наступит, потом удивляешься, что штаны не сходятся.",
    "Ты не сдаёшься, ты просто каждый день капитулируешь перед холодильником.",
    "У тебя не тяжёлая кость, у тебя лёгкие тормоза перед жратвой.",
    "Каждый раз, когда ты говоришь «живём один раз», твой жир аплодирует стоя.",
    "Пока другие качают мышцы, ты качаешь подбородки.",
    "Ты строишь не тело, а подушку безопасности вокруг талии.",
    "Даже твоя тень стала шире, задумайся.",
    "Ты не пропускаешь ни одного приёма пищи, зато отлично пропускаешь тренировки.",
    "Твои порции больше, чем твоя мотивация.",
    "Ты не «чуть-чуть набрал», ты целенаправленно инвестировал в свои бока.",
    "Каждый ужин после девяти — это вклад в твой жировой пенсионный фонд.",
    "Ты не голодный, ты просто не умеешь скучать без еды.",
    "Если бы лень сжигала калории, ты был бы уже сухим как спичка.",
    "Хочешь результат как у атлета, а живёшь как раскормленный кот.",
    "Твой главный кардио сейчас — это вздохи, когда надеваешь джинсы.",
    "Ты не просто ешь много, ты системно саботируешь своё будущее тело.",
    "Каждый твой «я заслужил» про еду — это приговор твоей талии.",
    "Живот не берётся из воздуха, он берётся из твоих повторяющихся слабостей.",
    "Ты не толстый, ты просто слишком уважаешь фастфуд.",
    "Если ты не контролируешь вилку, не жалуйся на то, что не можешь контролировать вес.",
    "Твои фото «до» уже давно просят фото «после», а не «ещё больше до».",
    "Ты не устаёшь от спорта, ты боишься выйти из зоны комфортного обжорства.",
    "Каждый день без движения — подарок твоим бокам.",
    "Ты не считаешь шаги, ты считаешь только подходы к холодильнику.",
    "Хочешь меньше весить — начни меньше оправдываться.",
    "Ты не «немного пухлый», ты лениво честен с самим собой.",
    "Твои тарелки выглядят так, будто ты готовишься к зимней спячке.",
    "Если ремень стал короче, значит, ты слишком часто говорил «в последний раз».",
    "Ты не просто любишь вкусно поесть, ты поклоняешься этому.",
    "Каждый заказ доставки — минус к форме и плюс к твоему пузу.",
    "Пока ты тянешься за сладким, твоя талия уже тянется в сторону XXL.",
    "Ты не в зал идёшь, ты от него бежишь в сторону кухни.",
    "Твоё тело — это отражение твоих привычек, а не чужих обстоятельств.",
    "Ты не устаёшь от недосыпа, ты устаёшь таскать свой жир.",
    "Каждый «перекус» на работе — это кирпичик в стену вокруг талии.",
    "Твои любимые упражнения — мысленные: «надо бы начать качаться».",
    "Ты не толстый, ты просто слишком часто награждаешь себя едой ни за что.",
    "Каждый твой лень-день — праздник для жира.",
    "Твой организм давно кричит «хватит», но ты слушаешь только шуршание упаковки.",
    "Ты не контролируешь порции — порции контролируют тебя.",
    "Когда ты жуёшь, ты молчишь, но твоя талия говорит громче всех.",
    "Тебе не нужна новая диета, тебе нужен режим без жрачных срывов.",
    "Твой лучший друг сейчас — плед и еда, а не кроссовки и зал.",
    "Ты не в плато, ты просто в фазе постоянного жора.",
    "Каждый раз, когда ты ленишься тренироваться, твой живот кивает и благодарит.",
    "Ты не прокачиваешь силу воли, ты прокачиваешь только объём тарелки.",
    "Если ты не можешь отказаться от сладкого, не удивляйся, что тебе тесно в своём теле.",
    "Твой жир — это накопленный кэшбек с каждого обеда.",
    "Ты не застрял, ты просто сидишь и ешь.",
    "Каждый заказ «ещё соус» — это бонус к окружности талии.",
    "Ты не голодный, ты просто увидел еду и решил, что это знак.",
    "Твои вечера выглядят как шведский стол, а не как путь к форме.",
    "Ты не старый, ты задыхаешься от собственного бездействия и веса.",
    "Каждый «сегодня можно» превращается в «завтра опять начинаю сначала».",
    "Если ты не готов немного пострадать в зале, будешь продолжать страдать, глядя на живот.",
    "Ты не ленишься — ты методично выбираешь путь наименее подтянутой задницы.",
    "Каждый батончик — это маленький удар по твоей мечте о прессе.",
    "Ты не строишь характер, ты строишь склад стратегического сала.",
    "Твои завтраки выглядят как прощальный ужин перед диетой, которая никогда не начнётся.",
    "Ты не толстый от одного торта, ты толстый от вечного «да пофиг».",
    "Каждый шаг мимо зала — это шаг навстречу ещё одному размеру одежды.",
    "Ты не забыл, как тренироваться, ты просто привык, как жрать.",
    "Твоё тело устало от твоей слабости, а не от тренировки.",
    "Каждый кофе с печенькой — маленький шажок к большому пузу.",
    "Ты не борешься с весом, ты живёшь с ним в тёплых отношениях.",
    "Если бы ты так же старался в зале, как в поисках вкусняшек, уже был бы в форме.",
    "Твои «я занят» звучат громче, чем твои шаги на беговой дорожке.",
    "Каждый вечерний сериал у телевизора — это минус к форме, плюс к дряблости.",
    "Ты не толстый, ты просто долго шёл к этому холодильным марафоном.",
    "Каждый лишний глоток колы — ещё одна микролопата жира в твой живот.",
    "Ты не забыл про цели, ты их просто заел.",
    "Твои фотки с едой в сторис говорят о тебе больше, чем селфи в зеркале зала.",
    "Каждый праздник для тебя — это официальное разрешение жрать без тормозов.",
    "Ты не никак не худеешь, потому что не можешь сказать себе «стоп» вовремя.",
    "Твоё тело давно просит движения, а ты кормишь его булками.",
    "Каждый твой «не сегодня» в зале — это «давай ещё» для жира.",
    "Ты не строишь силу, ты строишь только оправдания.",
    "Твои ручки поднимают только вилку, а не гантели.",
    "Каждый заход на кухню — маленький квест по саморазрушению формы.",
    "Ты не заедешь пустоту, ты просто заполнишь её майонезом.",
    "Твои кроссовки пылятся, зато холодильник у тебя в хорошей форме.",
    "Ты не хочешь худеть, ты хочешь жрать и при этом чудес.",
    "Каждый шуршащий пакет ночью — это твой личный будильник для роста жира.",
    "Ты не толстый случайно, ты толстый закономерно.",
    "Твои тарелки давно перешли на формат «для троих».",
    "Каждый твой сладкий перекус в офисе — ещё один шрам на ремне.",
    "Ты не «устал», ты просто разленился под соусом из своих отговорок.",
    "Твои выходные — это не отдых, а фестиваль прожорства.",
    "Каждый раз, когда ты проматываешь видео с тренировками и смотришь еду, мир толстеет вместе с тобой.",
    "Ты не потерял мотивацию, ты поменял её на пирожок.",
    "Твои цели в голове, а пирожки — в руках. Вот и весь результат.",
    "Каждый обед «как последний» делает твою талию всё более бесконечной.",
    "Ты не жертва обмена веществ, ты заложник своего аппетита.",
    "Твой живот первым заходит в комнату. Не смущает?",
    "Каждый кусочек «за компанию» — это килограммы, которые потом придётся таскать одному.",
    "Ты не забыл, каково быть легче, ты просто давно туда не стремился.",
    "Твои ступени стонут не от старости, а от того, кто по ним ходит.",
    "Каждый второй ужин — это лишний первый подбородок.",
    "Ты не виноват в том, что хочешь есть, но ты отвечаешь за то, что не умеешь остановиться.",
    "Твои слова «я всё контролирую» смешат даже твою растущую талию.",
    "Каждый твой «ну я же не каждый день» уже давно превратился в «каждый».",
    "Ты не сломался, ты просто прогнулся под свои хотелки.",
    "Твоё тело — результат, а не случайность. Смотри честно, а не сквозь булку.",
    "Каждый новый размер одежды — это медаль за твою лень.",
    "Ты не толстый, ты просто давно не говорил себе «нет».",
    "Твои друзья — доставка и диван. Остальные давно ходят без одышки.",
    "Каждый тост — это ещё одна капля жира на талии.",
    "Ты не устал пытаться, ты устал хотя бы немного себя ограничивать.",
    "Твоё дыхание после пары шагов — лучшая аудиореклама кето-диеты.",
    "Каждый отход от плана питания — это приход новых сантиметров.",
    "Ты не слабый, ты просто выбираешь не бороться.",
    "Твоя жвачка не отменяет тот торт, который ты в себя зарядил.",
    "Каждый твой «я заслужил вкусненькое» — это наказание для твоей фигуры.",
    "Ты не становишься лучше от еды, ты просто становишься больше.",
    "Твоя тарелка — единственное, что сейчас растёт стабильно.",
    "Каждый твой хруст чипсов — это треск твоих фитнес-планов.",
    "Ты не был «слегка вялым», ты давно перегружен собственной массой.",
    "Твои мысли о спорте сгорают быстрее, чем ты доедешь свою шаурму.",
    "Каждый похрустивший сухарик — это тихое «спасибо» от твоего жира.",
    "Ты не зависим от еды, ты просто боишься жить без постоянной жрачки.",
    "Твоя майка обтягивает не мышцы, а твой саботаж.",
    "Каждый день без контроля еды — ещё один плюс к тому, что ты видишь в зеркале и ненавидишь.",
    "Ты не толстяк по судьбе, ты толстяк по выбору вилки.",
    "Ну что, жиртрест, записал очередную подлянку для талии?",
    "Каждый лишний кусок — это ещё один шов на твоих штанах.",
    "Жир не плачет, жир просто тихо растёт. Следи за цифрами.",
    "Кормить внутреннего кабана мы уже закончили или ещё нет?",
    "Холодильник — не лучший друг, запомни это, пузатик.",
    "Жирок сам себя не сожжёт, ккалочку за ккалочкой давай сюда.",
    "Твой жир сейчас читает это сообщение и посмеивается — он знает, что ты его не бросишь.",
    "У тебя на животе можно играть в крестики-нолики, только выигрывает всегда жир.",
    "Ты не толстый, ты — вместительное хранилище для будущего дерьма.",
    "Твои ляжки трутся друг о друга чаще, чем у кошек в марте, только вот котикам это простительно.",
    "Заправлять рубашку в такие штаны — все равно что натягивать чехол на диван.",
    "Твой второй подбородок уже подал заявку на отдельный паспорт.",
    "Складки на спине такие глубокие, что туда можно прятать заначку от самого себя.",
    "Ты не человек, ты — надувная кукла, только вместо воздуха у тебя сало.",
    "Талия? У тебя не талия, а экватор.",
    "Когда ты поворачиваешься, твоя попа приходит на пять минут позже.",
    "У тебя пупок теперь похож на дно переполненной пепельницы.",
    "Твой жир — это твой единственный верный друг, который никогда тебя не бросит, потому что врос в тебя.",
    "С такими боками тебе не шорты нужны, а тент для грузовика.",
    "Твои щеки такие, что создают тень в пасмурный день.",
    "Ты не толстый, ты — архитектурный памятник собственной жадности.",
    "Когда ты сидишь на унитазе, вода выплескивается наружу от переизбытка массы.",
    "Твой жир на руках мешает тебе дотянуться до совести.",
    "У тебя на спине растут не крылья, а два мешка с салом.",
    "Ты круглый, как шар для боулинга, только вот сшибаешь ты не кегли, а свое здоровье.",
    "Если бы твой жир был деньгами, ты бы давно купил остров.",
    "Ну что, хомяк, опять набиваешь защечные мешки?",
    "Ты не кушал, ты мигрировал к холодильнику, как лемминг к обрыву.",
    "Кормушка для свиней закрыта, хрюндель.",
    "Ты не худеешь, ты просто линяешь — сбрасываешь шерсть, но не жир.",
    "Внутренний тюлень сегодня выполз на охоту?",
    "Ты ешь так, будто завтра впадаешь в спячку на 5 лет.",
    "Даже медведь перед спячкой жрет меньше, чем ты перед сном.",
    "Ну что, бочонок с медом, нашел свою палочку?",
    "Ты не ешь, ты пасешься. Целый день на продовольственном лугу.",
    "Твой организм — это свалка, а ты — главный мусоровоз.",
    "Ты как корова: сначала жуешь, потом жуешь, а потом у тебя молоко? Нет, просто жир.",
    "Бегемотик, твое болото уже пересохло от твоей жадности.",
    "Ты не кот, ты сфинкс, только складки у тебя не породистые, а жировые.",
    "Аллигатор, который сожрал все свои ноги.",
    "Ты как панда: только жрешь, спишь и ждешь, пока тебя кто-то спасет.",
    "В твоем зоопарке сегодня пополнение — еще один килограмм.",
    "Ты ешь, как не в себя, потому что себя уже давно не видно.",
    "Твой любимый зверь — холодильник. Вы неразлучны.",
    "Ты — гусеница, которая так и не хочет стать бабочкой, потому что боится похудеть.",
    "Чавкай тише, свинтус, соседи думают, что у нас тут ферма.",
    "Ты слабак. Твоя сила воли дохлее, чем твоя потенция.",
    "Ты даже себе отказать не можешь, куда ты лезешь строить карьеру/семью?",
    "Ты проигрываешь битву с куском мяса. Ты осознаешь всю глубину падения?",
    "Еда любит тебя больше, чем ты сам себя. И предает она тебя тоже каждый день.",
    "Твоя проблема не в костях, а в том, что ты не можешь сказать нет пирожку.",
    "Ты выглядишь так, будто всю жизнь ел не для энергии, а для горя.",
    "Твое лицо такое же одутловатое, как твои обещания начать новую жизнь с понедельника.",
    "Ты — ходячий мем про потом.",
    "Посмотри в зеркало. Это не ты, это памятник твоей лени.",
    "Ты не заслуживаешь быть стройным, потому что не готов ради этого страдать.",
    "Твой главный талант — умение быстро двигать челюстью.",
    "Ты не имеешь права ныть о жизни, пока в тебе столько лишнего веса.",
    "Ты выглядишь как человек, который сдался.",
    "Даже твоя тень толстая.",
    "Ты сам виноват, что твое тело стало похоже на диван.",
    "Ты отвратителен в зеркале, и причина этому — твой рот.",
    "Ты — ходячее доказательство того, что эволюция дала сбой.",
    "Другие бегают за девочками/мальчиками, а ты бегаешь за булочками.",
    "Ты пахнешь не парфюмом, а потом и жареным маслом.",
    "Ты — посмешище для своих артерий.",
    "Твой пульс — это звук работы сердца под нагрузкой. Всегда.",
    "Сахар в крови уже не измерить — глюкометр зашкаливает и плачет.",
    "Твои суставы скоро подадут в суд за жестокое обращение.",
    "У тебя одышка даже в мыслях о спорте.",
    "Твой холестерин такой густой, что его можно резать ножом.",
    "Печень скоро попросится на выход.",
    "Ты не толстый, ты — диабетик в режиме ожидания.",
    "Твое сердце работает за двоих. Жаль, что ты жрешь за троих.",
    "Давление скачет выше, чем твоя самооценка после съеденного торта.",
    "Врачи прячутся, когда видят тебя на горизонте.",
    "Твой организм — это тонущий корабль, а ты продолжаешь грузить его углем.",
    "Инсулиновый насос завидует твоему аппетиту.",
    "Ты не просто толстый, ты — ходячий инфаркт.",
    "Твоя поджелудочная плачет кровавыми слезами каждый раз, когда ты открываешь рот.",
    "Еще пара килограмм, и сердце попросит пересадку от слона.",
    "Вены не видно под слоем сала.",
    "Ты — идеальный кандидат на шоу Взвешенные люди.",
    "У тебя даже пот жирный.",
    "Если бы калории были деньгами, ты бы обанкротил бюджет страны.",
    "Ты не умираешь от голода, ты умираешь медленно от обжорства.",
    "Твоя одежда сидит на тебе как чехол для мебели.",
    "В магазине ты покупаешь не вещи, а тряпки, которые просто сходятся на животе.",
    "Твой размер — это ой, а что есть побольше?.",
    "Джинсы натирают так, будто пытаются сбежать от тебя.",
    "Ты не одеваешься, ты заворачиваешься.",
    "Пуговицы на твоей рубашке держатся из последних сил на честном слове.",
    "В переполненном автобусе ты занимаешь два места сразу, даже если сидишь.",
    "Друзья зовут есть только для того, чтобы посмотреть на шоу.",
    "Ты не ешь в гостях, ты объедаешь хозяев.",
    "Твой ремень — это линия перемены дат на карте твоего пуза.",
    "В кинотеатре ты заслоняешь экран собой.",
    "Люди обходят тебя стороной не потому что боятся, а чтобы не застрять в складках.",
    "Твоя тень уже сама по себе ищет тенек.",
    "Тебе не нужно кресло, тебе нужен трон.",
    "Ты не влезаешь в кадр на общих фото.",
    "Весы под тобой плачут и просят пощады.",
    "Ты не носишь одежду, ты ее натягиваешь как бампер на КамАЗ.",
    "Футболка на пузе смотрится как юбка.",
    "Ты покупаешь вещи на вырост? Поздно, ты уже перерос все мыслимые пределы.",
    "Твой гардероб — это коллекция балахонычей.",
    "Еще ложка — и ты лопнешь. Давай, рискни.",
    "Жри, жри, это последнее, что ты умеешь делать хорошо.",
    "Ты не обедаешь, ты проводишь ревизию холодильника.",
    "Твой холодильник пустеет быстрее, чем твои мозги наполняются мыслями.",
    "Ты ешь не потому что голоден, а потому что тебе скучно/грустно/весело. Ты — эмоциональный унитаз.",
    "Ты ищешь еду на кухне? Она уже ищет тебя в боках.",
    "У тебя нет пищевых привычек, у тебя есть пищевая зависимость.",
    "Ты жуешь даже тогда, когда спишь. Во сне.",
    "Десерт — это еда для тех, кто уже нажрался основным. Ты в теме.",
    "Ты ешь как в последний раз. И этот раз наступает каждый день.",
    "Салатик? Ой, да ладно, налей майонеза побольше, все равно в тебе ничего не испортишь.",
    "Ты не чувствуешь вкуса, ты чувствуешь только объем.",
    "Твой желудок — это бездонная бочка.",
    "Ты не умеешь останавливаться, ты умеешь только падать в обморок от обжорства.",
    "Ты ешь так быстро, будто кто-то отнимет.",
    "Тарелка пустая? А почему ты еще нет?",
    "Ты не готовишь, ты производишь калории.",
    "Перекус? У тебя весь день один сплошной перекус.",
    "Ты не знаешь чувства сытости, ты знаешь только чувство больше не лезет.",
    "Золотая медаль по скоростному поеданию бутербродов уходит... опять к тебе!",
    "Хочешь дожить до 40? Тогда хватит есть как на 90.",
    "Твои внуки будут гордиться тобой... фотографией до и после, где после так и не наступило.",
    "Старость будет тяжелой, если ты донесешь до нее такой вес.",
    "Ты не состаришься, ты просто рассыплешься от диабета.",
    "В 50 ты будешь мечтать, чтобы тебя могли поднять с кровати.",
    "Ты готовишь себе инвалидную коляску своими руками (и челюстью).",
    "Жир съест тебя раньше, чем ты его.",
    "Памятник тебе поставят, но только очень широкий.",
    "Твое будущее — это весы у кровати и капельница.",
    "Ты строишь из себя воздушный шарик, который вот-вот лопнет.",
    "Ты коллекционируешь килограммы, как другие коллекционируют достижения.",
    "Вместо пенсии ты копишь жир.",
    "Ты умрешь не от счастья, а от инфаркта, вызванного ожирением.",
    "Твоя могила будет шире, чем глубже.",
    "Рай для тебя — это холодильник, который никогда не кончается. Ад — это совесть, которая никогда не молчит.",
    "Встать с дивана — для тебя уже подвиг.",
    "Тренировка — это поход от холодильника до кровати и обратно.",
    "Твой спортзал — это кухня. Твоя гантеля — это ложка.",
    "Бегать? Ты и ходишь-то с трудом.",
    "Ты настолько ленив, что даже жир на тебе ленится сгорать.",
    "Твоя сила воли похожа на диету — ее нет.",
    "Ты легко бросаешь есть... только вилку, и то, чтобы взять ложку.",
    "Твой план похудения: Не жрать после шести. Сейчас семь, ты уже все сожрал до шести?",
    "Завтра — любимый день недели, чтобы начать худеть.",
    "Ты ищешь волшебную таблетку, но она зарыта в твоей лени.",
    "Тебе лень даже дышать, поэтому ты копишь углекислый газ вместе с жиром.",
    "Ты не можешь отказаться от еды, потому что это единственное, что тебе не лень делать.",
    "Твоя мотивация длится ровно до запаха жареной картошки.",
    "Ты хочешь похудеть, не вставая с дивана. Чудес не бывает, бывает только липосакция.",
    "Ты — амёба, которая просто поглощает всё вокруг.",
    "Ой, кажется, кто-то забыл положить еду в рот 2 часа назад. Срочно жрать!",
    "Ты уже завтракаешь? А обедал ты ещё вчера.",
    "Не ешь, тебе это в бока встанет.",
    "Помнишь тот вкусный ужин? Он теперь на твоей талии.",
    "Каждая крошка ищет свое место. И находит его у тебя на боках.",
    "Сладкое — это наркотик. А ты — законченный наркоман.",
    "Еда — твой самый преданный враг.",
    "Ты не ешь, ты топливо заливаешь в печку, которая давно прогорела.",
    "Хочешь конфетку? Получишь прыщ и сантиметр на талии.",
    "За обе щеки — это про тебя. И за третью, и за четвертую.",
    "Ты как белка, только вместо орешков запасаешь целлюлит.",
    "Скажи еде нет. Ну хотя бы разок, слабак.",
    "Твоя тарелка должна быть меньше, а совесть — больше.",
    "Жуй медленнее, так ты хотя бы растянешь удовольствие от единственного радости в жизни.",
    "Не доедай за детьми, они не виноваты, что у тебя нет силы воли.",
    "Толстяк, иди сюда, тебе пришло письмо от твоего желудка: Хочу добавки!.",
    "Ты не в форме? Ты в форме шара.",
    "Твой индекс массы тела зашкаливает и ломает калькулятор.",
    "Ты выглядишь как человек, который ест, чтобы жить? Нет, ты выглядишь как человек, который живет, чтобы есть.",
    "Ты — ходячая реклама анти-фитнеса.",
    "У тебя даже пальцы толстые, чтобы ложку удобнее держать.",
    "Твой пульс можно нащупать только через слой жира.",
    "Твоя походка — это перекатывание туши.",
    "Ты садишься на стул, а стул садится на пол.",
    "Ты как матрешка: только внутри не другая матрешка, а такой же толстяк.",
    "Ты не полный, ты — всеобъемлющий.",
    "Ты — человек-гора. Только вот гора должна быть величественной, а ты просто колобок.",
    "Твоя кожа растянута так, что можно барабан сделать.",
    "Ты — ходячий упрек самому себе.",
    "Ты победитель по жизни? По жизни ты едок.",
    "Твоя сила воли — это анекдот, который ты рассказываешь себе перед сном.",
    "Жир на твоем лице уже искажает черты до неузнаваемости.",
    "Ты не стареешь, ты расширяешься.",
    "Твои фотографии в профиль не помещаются в экран.",
    "Ты ешь даже тогда, когда тебе плохо. Тебе всегда плохо, потому что ты много ешь. Замкнутый круг жирдяя.",
    "Ты как свинья, только грязнее — ты внутри грязный от шлаков.",
    "Твой организм — это помойное ведро.",
    "Ты не просто любишь поесть, ты боготворишь еду.",
    "Вместо сердца у тебя кусок сала.",
    "Ты думаешь, что толстый — это красиво? Нет, это удобно — прятать лень за ложным принятием.",
    "Ты толстый не потому что кость широкая, а потому что жопа широкая.",
    "Твоя жадность не знает границ, как и твой живот.",
    "Ты не можешь купить нормальную одежду, потому что производители не шьют на батискафы.",
    "Ты похож на надувной матрас, который решил съесть себя сам.",
    "Ты ешь, чтобы заглушить боль? Боль от того, что ты толстый?",
    "Салфетка тебе нужна не для рта, а чтобы вытирать жир с подбородков.",
    "Ты чавкаешь так, что соседи стучат по батареям, просят добавки.",
    "Тебе не нужен спутник в жизни, тебе нужен носильщик для твоего пуза.",
    "Ты думаешь, что диета — это ущемление прав? Нет, это спасение твоей задницы.",
    "Твоя задница давно живет своей жизнью и просит отдельное место в парламенте.",
    "Ты не заслуживаешь секса, пока у тебя пузо не помещается в штаны.",
    "Твой внешний вид кричит: Пожалейте меня, я слабак.",
    "Ты так давно не видел свои гениталии, что забыл, как они выглядят.",
    "Тебе проще купить торт, чем купить гантели.",
    "Ты — человек, который сдался под натиском майонеза.",
    "Твой девиз: Сегодня последний день — и так каждый день.",
    "Ты жрешь, как будто завтра ядерная война и еды не будет.",
    "Ты — стратегический запас углеводов своей страны.",
    "Твои щеки свисают так, что можно завязывать бант.",
    "Ты не человек, ты — мешок с костями, обмазанный жиром.",
    "Твой живот перевешивает твои мозги.",
    "Ты думаешь головой? Нет, ты думаешь желудком.",
    "Ты не можешь отказаться от сладкого, потому что ты сладкоежка? Ты просто бесхребетный.",
    "Ты ешь на ночь? А как же советы? А советы для стройных.",
    "Ты уже смирился? Смирись еще с тем, что ты умрешь рано.",
    "Твое тело — это тюрьма, которую ты построил сам из еды.",
    "Ты ешь не для жизни, а для смерти.",
    "Калории — это кирпичики, из которых ты строишь себе надгробие.",
    "Ты — ходячее противоречие: хочешь жить долго, но ешь как на пожизненное.",
    "Ты не умеешь худеть, но отлично умеешь толстеть.",
    "Очередная диета с понедельника? А сегодня что, воскресенье? Жри давай, пока не поздно.",
    "Ты набираешь вес быстрее, чем зарплату.",
    "Твои успехи — это успехи на ниве обжорства.",
    "Ты достиг дна? Нет, ты проел его.",
    "Ты выглядишь как шарик для боулинга в розовых штанишках.",
    "Твой любимый вид спорта — скоростное поедание пельменей.",
    "Ты не знаешь меры, ты знаешь только край.",
    "Тебе уже все равно? А твоему сердцу не все равно.",
    "Твоя печень скоро лопнет от жира.",
    "Ты не толстый, ты — терминатор, только уничтожаешь ты себя.",
    "Ты — живой пример того, как не надо жить.",
    "Дети показывают на тебя пальцем, а мамы говорят: Не ешь много, будешь как дядя.",
    "Ты — анти-пример для подражания.",
    "Ты думал, что любовь к еде заменит любовь к жизни? Нет.",
    "Ты одинок, потому что толстый, и толстый, потому что одинок. Разорви круг, ленивая задница.",
    "Ты ешь, потому что тебе грустно. Тебе грустно, потому что ты ешь.",
    "Ты как хомяк, только с амбициями.",
    "Твоя жизнь — это череда перекусов.",
    "Между завтраком и обедом у тебя перекус, между обедом и ужином — перекус, после ужина — ну как же без перекуса.",
    "Ты не ешь по расписанию, ты ешь по позыву.",
    "Твой позывной — Обжора.",
    "Ты — радио, которое вещает только на волне Еда.",
    "Ты смотришь кулинарные шоу и пускаешь слюни? А ты иди и пожуй, чего время терять.",
    "Твой любимый жанр в кино — фильмы про еду.",
    "Ты книгу откроешь? Там про диету написано. Не надо, лучше закрой.",
    "Ты не читаешь, ты жуешь.",
    "Твой мозг атрофировался от углеводов.",
    "Ты тупеешь с каждым килограммом.",
    "Жир давит на мозги? Нет, мозги просто утонули в жиру.",
    "Ты не способен мыслить критически, когда видишь пирожное.",
    "Сладкий вкус во рту — это вкус твоего будущего диабета.",
    "Хруст чипсов — это хруст твоих суставов.",
    "Мясо — это сила. Сила твоего живота расти.",
    "Хлеб — всему голова. И твоему животу тоже.",
    "Макароны — это энергия. Энергия для поиска новой еды.",
    "Ты ешь фастфуд? Ты ешь быструю смерть.",
    "Ты пьешь газировку? Ты пьешь жидкий сахар, который осядет на попе.",
    "Ты любишь пиво? Люби и живот расти.",
    "Алкоголь разжигает аппетит? Тебе и разжигать не надо, у тебя там пожизненный костер.",
    "Ты — ходячий пивной бочонок.",
    "Ты как снежный ком: катишься по жизни и обрастаешь жиром.",
    "Ты не идешь, ты перетекаешь.",
    "Твоя походка вразвалочку — это походка моржа на лежбище.",
    "Ты садишься в машину, и она приседает.",
    "Ты ложишься на диван, и диван уходит в пол.",
    "Твой вес — это проблема лифта.",
    "Лифт с тобой едет с предупреждением о перегрузе.",
    "Ты выходишь из лифта, и он подпрыгивает от счастья.",
    "Ты наступаешь на весы, и они показывают ERROR.",
    "Весы плачут, когда видят тебя.",
    "Ты не можешь завязать шнурки, потому что живот мешает.",
    "Ты не видишь своих ног, когда стоишь.",
    "Ты моешься в душе и не можешь дотянуться до спины.",
    "Ты вытираешь попу и рука устает.",
    "Ты храпишь так, что соседи вызывают МЧС.",
    "Ты потеешь от одного взгляда на солнце.",
    "Ты задыхаешься, когда говоришь по телефону.",
    "У тебя постоянно красное лицо от давления.",
    "Ты носишь только черное, чтобы казаться стройнее? Не помогает, бегемот.",
    "Черный цвет не стройнит, он просто скрывает твои очертания, как ночь скрывает горы.",
    "Ты покупаешь одежду на размер больше, думая, что похудеешь и она станет впору? Не надейся.",
    "Твои старые джинсы хранятся как музейный экспонат Как я был молод и строен.",
    "Ты не влезаешь в старую одежду, но влезаешь в старые привычки.",
    "Ты как скульптура, только лепил тебя не художник, а повар.",
    "Твое тело — это результат творчества шеф-повара.",
    "Ты — произведение кулинарного искусства.",
    "Ты — ходячий натюрморт.",
    "Ты — пейзаж, на который без слез не взглянешь.",
    "Твоя фигура вдохновляет художников-абстракционистов.",
    "Ты — живой укор Пикассо.",
    "Ты говоришь, что любишь себя любой? Ты просто оправдываешь свою лень.",
    "Любить себя — значит заботиться, а не закармливать до смерти.",
    "Ты не любишь себя, ты убиваешь себя медленно.",
    "Твое тело просит пощады, а ты пихаешь в него котлету.",
    "Твой организм кричит SOS, а ты несешь ему гамбургер.",
    "Ты глух к мольбам своего сердца.",
    "Ты слеп к своему отражению.",
    "Ты нем, когда надо сказать нет еде.",
    "Ты — инвалид своей силы воли.",
    "Ты — калека своего аппетита.",
    "Ты не умеешь терпеть голод? Научись, пригодится, когда сядетешь на медицинскую диету.",
    "Ты не знаешь, что такое голод? Спроси у своих клеток, они знают.",
    "Ты путаешь голод и жажду? Ты путаешь все, лишь бы пожрать.",
    "Твой желудок урчит не от голода, а от жадности.",
    "Ты хочешь есть, хотя поел час назад? Ты просто хочешь жрать.",
    "Ты — раб своего желудка.",
    "Твой желудок — тиран, а ты — его покорный слуга.",
    "Ты носишь еду своему господину — жиру.",
    "Ты — прислуга у собственного тела.",
    "Твой хозяин — это твой жир, и он требует дани.",
    "Ты не можешь пройти мимо кондитерской? Раб.",
    "Ты не можешь не купить чипсы в магазине? Раб.",
    "Ты доедаешь, даже если сыт? Раб.",
    "Ты ешь, когда не голоден? Раб.",
    "Ты ешь, чтобы успокоиться? Раб эмоций.",
    "Ты — эмоциональный вампир, который питается страданиями своей печени.",
    "Ты вампир, но пьешь не кровь, а подсолнечное масло.",
    "Ты — оборотень, но превращаешься не в волка, а в мешок с салом.",
    "Ты — зомби, который думает только о мозгах, то есть о еде.",
    "Ты — мутант, результат генной инженерии фастфуда.",
    "Ты — ошибка эволюции.",
    "Ты — тупиковая ветвь развития.",
    "Ты — природа, которая пошутила.",
    "Ты — биологический курьез.",
    "Ты — экспонат кунсткамеры.",
    "Ты — чудо природы, но в плохом смысле.",
    "Ты — анти-человек.",
    "Ты — существо, основная цель которого — потребление.",
    "Ты — функция, а не личность.",
    "Ты — приложение к холодильнику.",
    "Ты не толстый, ты просто большой любитель покушать. Большой во всех смыслах.",
    "Твоя любовь к еде безответна. Еда тебя использует и бросает.",
    "Еда — твоя единственная любовь, и она тебя убивает.",
    "Твой роман с едой закончится на вскрытии.",
    "Вы с едой — токсичные отношения.",
    "Разведись с едой, подай на развод.",
    "Ты изменяешь здоровью с едой.",
    "Твой муж/жена — еда, и она тебя не ревнует, ей все равно.",
    "Ты в отношениях, где тебя только используют.",
    "Ты — жертва абьюза со стороны еды.",
    "Ты ешь от скуки? Найди хобби, кроме жевания.",
    "Ты ешь от стресса? Научись дышать, а не жрать.",
    "Ты ешь за компанию? У тебя своя голова на плечах?",
    "Ты ешь, потому что вкусно? Вкусно — не значит полезно.",
    "Ты ешь, потому что бесплатно? Бесплатный сыр только в мышеловке, жирная мышь.",
    "Ты ешь, потому что жалко выбрасывать? Пожалей себя, не выбрасывай в себя мусор.",
    "Ты — мусорное ведро для остатков еды.",
    "Ты — доширак для самого себя.",
    "Ты — компостная яма.",
    "Ты — свалка отходов пищевой промышленности.",
    "Ты лопаешь, как не в себя, потому что себя уже не видно из-за пуза.",
    "Твой пупок вывернулся наизнанку от натуги.",
    "Твой пупок похож на кратер вулкана, который вот-вот извергнет лаву из майонеза.",
    "Твой живот колышется, как желе.",
    "Твой второй подбородок завел себе третий.",
    "У тебя не подбородки, а лестница в ад.",
    "Твои щеки свисают до плеч.",
    "Твои скулы утонули в жиру давным-давно.",
    "Твой нос выглядит как маленький островок в океане лица.",
    "Твои глаза заплыли так, что ты смотришь на мир сквозь щелочки.",
    "Ты не видишь дальше своего носа, потому что нос утонул в щеках.",
    "Твой мир сузился до размеров тарелки.",
    "Твой кругозор ограничен меню ресторана.",
    "Ты не видишь дальше собственного живота.",
    "Твой главный интерес — что сегодня на ужин.",
    "Твоя жизнь — это повторяющийся цикл: жрать, спать, жрать.",
    "Ты как персонаж Дня сурка, только сурок этот — жирный.",
    "Ты застрял во временной петле обжорства.",
    "Ты не развиваешься, ты растешь вширь.",
    "Твой личностный рост измеряется в сантиметрах талии.",
    "Ты деградируешь с каждым съеденным пирожком.",
    "Ты глупеешь на глазах.",
    "Ты теряешь человеческий облик.",
    "Ты превращаешься в животное, руководствующееся инстинктами.",
    "Инстинкт самосохранения у тебя атрофировался.",
    "Ты не хочешь жить долго и счастливо, ты хочешь жить вкусно и недолго.",
    "Твой выбор сделан. Ты выбрал смерть от обжорства.",
    "Ты подписал себе приговор вилкой.",
    "Твоя еда — это твой палач.",
    "Ты сам себе могильщик.",
    "Ты роешь себе яму ложкой.",
    "Каждый твой прием пищи — это удар лопатой.",
    "Ты строишь себе склеп из гамбургеров.",
    "Твой надгробный камень будет весить полтонны, как и ты.",
    "На твоих похоронах будет тесно в гробу.",
    "Гроб закажут в магазине мебели.",
    "Тебя будут хоронить с помощью крана.",
    "Твоя смерть будет дорогостоящей из-за размеров.",
    "Но никому не будет тебя жаль, потому что ты сам виноват.",
    "Все скажут: Сам дохрюкался.",
    "Твои дети будут стыдиться тебя на пляже.",
    "Твоя жена/муж спит с тобой только из жалости.",
    "Ты внушаешь отвращение, а не любовь.",
    "На тебя не хочется смотреть, тебя хочется кормить и убрать в клетку.",
    "Ты похож на домашнее животное, которое перекормили.",
    "Ты — посмешище для своих друзей.",
    "Друзья смеются над тобой за глаза, а в глаза подкладывают еду.",
    "Ты — объект для шуток.",
    "Ты — ходячий анекдот.",
    "Твоя жизнь — это фарс.",
    "Ты — карикатура на самого себя.",
    "Ты — пародия на человека.",
    "Ты — шарж, сошедший со страниц газеты.",
    "Ты — клоун, только без грима, жир — твой грим.",
    "Ты — цирковой толстяк, только без цирка.",
    "Ты выступаешь на арене собственной кухни.",
    "Твоя аудитория — мухи над тарелкой.",
    "Ты — звезда Youtube, только в жанре обзорщик еды",
    "Ты — блогер-гастроэнтеролог, который показывает, к чему приводит обжорство.",
    "Ты — инфлюенсер с негативным влиянием.",
    "Ты вдохновляешь людей на борьбу с ожирением — своим примером до.",
    "Ты — мотиватор от противного.",
    "Глядя на тебя, хочется заняться спортом.",
    "Глядя на тебя, хочется удавиться.",
    "Ты — живое доказательство того, что уродство бывает рукотворным.",
    "Ты уродлив не лицом, а своими привычками.",
    "Твоя душа так же заплыла жиром, как и тело.",
    "Ты толстый не только снаружи, но и внутри.",
    "Твои мысли жирные, как твоя еда.",
    "Ты думаешь только о том, как бы набить брюхо.",
    "Ты примитивен.",
    "Ты одноклеточный.",
    "Твои мозги — это жировая ткань.",
    "Ты не мыслишь, ты перевариваешь.",
    "Твой интеллект обратно пропорционален массе тела.",
    "Ты глуп, как пробка (от бутылки пива).",
    "Ты тупой, как сибирский валенок (размера 50).",
    "Ты несешь чушь, перемежая ее чавканьем.",
    "С тобой не о чем говорить, кроме еды.",
    "Ты скучный, как диета из гречки.",
    "Ты — пустое место.",
    "Ты — ноль без палочки (и без силы воли).",
    "Ты — никто.",
    "Ты — ничтожество, которое не может совладать с куском мяса.",
    "Ты — червь, который ест сам себя.",
    "Ты — слизень, оставляющий жирный след.",
    "Ты — гусеница, которая никогда не станет бабочкой.",
    "Ты — личинка, обреченная на гибель.",
    "Ты — паразит на теле планеты, потребляющий ресурсы без пользы.",
    "Ты — биомасса, которая просто перерабатывает еду в дерьмо и жир.",
    "Ты бесполезен.",
    "Твоя единственная функция — есть.",
    "Ты как растение, только вместо фотосинтеза у тебя жиросинтез.",
    "Ты — машина по утилизации еды.",
    "Ты — биореактор.",
    "Ты — фабрика по производству целлюлита.",
    "Твой КПД отрицательный.",
    "Ты приносишь только вред себе и окружающим (видом).",
    "Ты — обуза для системы здравоохранения.",
    "Ты — ходячая статья расходов для страховой компании.",
    "Ты — угроза для национальной безопасности (продовольственной).",
    "Ты опустошаешь полки магазинов.",
    "Ты — стихийное бедствие для холодильника.",
    "Ты — ураган, сметающий все съестное на своем пути.",
    "Ты — цунами, накрывающее обеденный стол.",
    "Ты — землетрясение, от которого дрожат полки.",
    "Ты — пожар, сжигающий калории? Нет, ты просто сжигаешь еду.",
    "Ты — катастрофа местного масштаба.",
    "Ты — апокалипсис для своего организма.",
    "Ты — конец света в отдельно взятом теле.",
    "Ты — черная дыра, поглощающая все вокруг.",
    "Твоя гравитация притягивает еду.",
    "Вокруг тебя образуется пищевая сингулярность.",
    "Ты — анти-материя для стройности.",
    "Ты — темная энергия, разрушающая тело.",
    "Ты — ошибка в матрице.",
    "Ты — глюк системы.",
    "Ты — баг, а не фича.",
    "Тебя нужно удалить из реальности.",
    "Reset не поможет, нужен жесткий диск.",
    "Ты безнадежен.",
    "Ты конченый.",
    "Ты пропащий.",
    "Ты потерян для общества стройных.",
    "Тебе уже ничего не поможет, кроме хирурга.",
    "Но даже хирург откажется резать такое количество сала.",
    "Ты — медицинский случай.",
    "Ты — диагноз.",
    "Ты — приговор.",
    "Ты — ходячее заключение патологоанатома.",
    "Сдайся. Жри дальше.",
    "Не мучай себя диетами, все равно сорвешься.",
    "Твоя сила воли — это миф.",
    "Ты не сможешь похудеть.",
    "Ты слишком слаб для этого.",
    "Прими свою участь толстяка.",
    "Живи в свое удовольствие, пока сердце не остановится.",
    "Заказывай гроб побольше.",
    "Мир не потеряет гения, потеряет обжору.",
    "Прощай, жиртрест.",
    "Это сообщение — капля в море твоего самообмана.",
    "Ты его прочитаешь и пойдешь есть.",
    "Потому что ты — предсказуемый.",
    "Потому что ты — слабак.",
    "Потому что ты — толстый.",
    "И это никогда не изменится.",
    "Никогда.",
    "Слышишь?",
    "Ты умрешь толстым.",
    "Аминь."
]


def get_bad_phrase() -> str:
    if not BAD_LIST:
        return ""
    return random.choice(BAD_LIST)


# --- Модели данных ---

class Role(str, Enum):
    FATTY = "Жиртрест"
    PIG = "Кабан"
    ALMOST_FIT = "Почти соска"
    NORMAL = "Норм чел"


@dataclass
class UserProfile:
    user_id: int
    username: str
    current_weight: float
    target_weight: float
    calorie_limit: int
    height_cm: int = 175
    age: int = 30
    gender: str = "male"
    activity_level: float = 1.375
    start_weight: Optional[float] = None

    def __post_init__(self):
        if self.start_weight is None:
            self.start_weight = self.current_weight

    def calculate_bmr(self) -> float:
        """Формула Миффлина-Сан Жеора (сколько организм тратит в покое)"""
        if self.gender == "female":
            return 10 * self.current_weight + 6.25 * self.height_cm - 5 * self.age - 161
        return 10 * self.current_weight + 6.25 * self.height_cm - 5 * self.age + 5

    def calculate_tdee(self) -> float:
        """Общий расход энергии с учётом активности (TDEE)"""
        return self.calculate_bmr() * self.activity_level

    def get_deficit_progress(self, today_calories: int = 0) -> Dict[str, float]:
        """
        Расчёт прогресса дефицита калорий.
        today_calories — фактически потреблённые калории сегодня (из entries.csv)
        """
        kcal_per_kg = 7700
        start = self.start_weight if self.start_weight else self.current_weight

        # Всего нужно сжечь для достижения цели
        total_deficit = max(0, (start - self.target_weight)) * kcal_per_kg

        # Уже сожжено — по факту потери веса (объективный показатель)
        achieved = max(0, (start - self.current_weight)) * kcal_per_kg

        # Остаток
        remaining = max(0, total_deficit - achieved)

        # TDEE и ежедневный дефицит
        tdee = self.calculate_tdee()
        daily_deficit = max(0, tdee - today_calories)  # ✅ Используем фактическое потребление!

        # Прогноз
        days_to_goal = remaining / daily_deficit if daily_deficit > 0 else float('inf')

        return {
            'total_deficit_needed': total_deficit,
            'deficit_achieved': achieved,
            'deficit_remaining': remaining,
            'daily_deficit': daily_deficit,
            'days_to_goal': days_to_goal,
            'tdee': tdee,
            'bmr': self.calculate_bmr(),
            'today_calories': today_calories,
        }

    @property
    def progress_percent(self) -> float:
        start = self.start_weight if self.start_weight else max(self.current_weight, self.target_weight * 1.5)
        if start <= self.target_weight:
            return 100.0
        progress = (start - self.current_weight) / (start - self.target_weight)
        return max(0.0, min(100.0, progress * 100))

    @property
    def role(self) -> Role:
        p = self.progress_percent
        if p < 25:
            return Role.FATTY
        if p < 50:
            return Role.PIG
        if p < 80:
            return Role.ALMOST_FIT
        return Role.NORMAL


@dataclass
class DailyEntry:
    date: date
    user_id: int
    username: str
    calories: int
    weight: Optional[float] = None
    exercises: str = ""


# --- Работа с CSV ---

def ensure_csv_files() -> None:
    if not USERS_CSV.exists():
        logger.info("Создание файла users.csv")
        with USERS_CSV.open("w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow([
                "user_id", "username", "current_weight", "target_weight", "calorie_limit",
                "height_cm", "age", "gender", "activity_level", "start_weight"
            ])

    if not ENTRIES_CSV.exists():
        logger.info("Создание файла entries.csv")
        with ENTRIES_CSV.open("w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow(["date", "user_id", "username", "calories", "weight", "exercises"])


def load_users() -> Dict[int, UserProfile]:
    ensure_csv_files()
    users: Dict[int, UserProfile] = {}
    try:
        with USERS_CSV.open("r", newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                try:
                    user_id = int(row["user_id"])
                    users[user_id] = UserProfile(
                        user_id=user_id,
                        username=row["username"],
                        current_weight=float(row["current_weight"]),
                        target_weight=float(row["target_weight"]),
                        calorie_limit=int(row["calorie_limit"]),
                        height_cm=int(row.get("height_cm") or 175),
                        age=int(row.get("age") or 30),
                        gender=row.get("gender") or "male",
                        activity_level=float(row.get("activity_level") or 1.375),
                        start_weight=float(row["start_weight"]) if row.get("start_weight") else None,
                    )
                except (ValueError, KeyError) as e:
                    logger.warning(f"Ошибка парсинга строки пользователя: {row}, ошибка: {e}")
                    continue
        logger.info(f"Загружено пользователей: {len(users)}")
    except Exception as e:
        logger.error(f"Критическая ошибка при загрузке users.csv: {e}")
    return users


def save_users(users: Dict[int, UserProfile]) -> None:
    ensure_csv_files()
    try:
        with USERS_CSV.open("w", newline="", encoding="utf-8") as f:
            writer = csv.writer(f)
            writer.writerow([
                "user_id", "username", "current_weight", "target_weight", "calorie_limit",
                "height_cm", "age", "gender", "activity_level", "start_weight"
            ])
            for u in users.values():
                writer.writerow([
                    u.user_id,
                    u.username,
                    f"{u.current_weight:.2f}",
                    f"{u.target_weight:.2f}",
                    u.calorie_limit,
                    u.height_cm,
                    u.age,
                    u.gender,
                    f"{u.activity_level:.3f}",
                    f"{u.start_weight:.2f}" if u.start_weight else "",
                ])
        logger.info(f"Сохранено пользователей: {len(users)}")
    except Exception as e:
        logger.error(f"Ошибка при сохранении users.csv: {e}")


def append_or_update_entry(entry: DailyEntry) -> None:
    ensure_csv_files()
    rows: List[Dict[str, str]] = []
    found = False
    try:
        with ENTRIES_CSV.open("r", newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                if row["user_id"] == str(entry.user_id) and row["date"] == entry.date.isoformat():
                    old_cal = int(row.get("calories") or 0)
                    row["calories"] = str(old_cal + entry.calories)
                    if entry.weight is not None:
                        row["weight"] = f"{entry.weight:.2f}"
                    if entry.exercises:
                        row["exercises"] = entry.exercises
                    found = True
                rows.append(row)

        if not found:
            rows.append({
                "date": entry.date.isoformat(),
                "user_id": str(entry.user_id),
                "username": entry.username,
                "calories": str(entry.calories),
                "weight": f"{entry.weight:.2f}" if entry.weight is not None else "",
                "exercises": entry.exercises,
            })

        with ENTRIES_CSV.open("w", newline="", encoding="utf-8") as f:
            fieldnames = ["date", "user_id", "username", "calories", "weight", "exercises"]
            writer = csv.DictWriter(f, fieldnames=fieldnames)
            writer.writeheader()
            writer.writerows(rows)
        logger.info(f"Запись обновлена/добавлена для user_id {entry.user_id} за {entry.date}")
    except Exception as e:
        logger.error(f"Ошибка при работе с entries.csv: {e}")


def load_entries_for_month(year: int, month: int, user_id: Optional[int] = None) -> List[DailyEntry]:
    ensure_csv_files()
    result: List[DailyEntry] = []
    try:
        with ENTRIES_CSV.open("r", newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                try:
                    d = date.fromisoformat(row["date"])
                except (TypeError, ValueError):
                    continue
                if d.year != year or d.month != month:
                    continue
                if user_id is not None and int(row["user_id"]) != user_id:
                    continue
                try:
                    calories = int(row["calories"])
                except (TypeError, ValueError):
                    calories = 0
                weight = None
                if row.get("weight"):
                    try:
                        weight = float(row["weight"])
                    except (TypeError, ValueError):
                        weight = None
                result.append(DailyEntry(
                    date=d,
                    user_id=int(row["user_id"]),
                    username=row["username"],
                    calories=calories,
                    weight=weight,
                    exercises=row.get("exercises", ""),
                ))
    except Exception as e:
        logger.error(f"Ошибка загрузки записей за {year}-{month}: {e}")
    return result


def get_available_months(user_id: Optional[int] = None) -> List[Tuple[int, int]]:
    """Возвращает список уникальных (year, month) из entries.csv."""
    ensure_csv_files()
    months_set: Set[Tuple[int, int]] = set()
    try:
        with ENTRIES_CSV.open("r", newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                if user_id is not None and int(row["user_id"]) != user_id:
                    continue
                try:
                    d = date.fromisoformat(row["date"])
                    months_set.add((d.year, d.month))
                except (TypeError, ValueError):
                    continue
    except Exception as e:
        logger.error(f"Ошибка при получении доступных месяцев: {e}")

    return sorted(months_set, key=lambda x: (x[0], x[1]), reverse=True)


def load_entries_for_user(user_id: int) -> List[DailyEntry]:
    """Загружает все записи для конкретного пользователя."""
    ensure_csv_files()
    result: List[DailyEntry] = []
    try:
        with ENTRIES_CSV.open("r", newline="", encoding="utf-8") as f:
            reader = csv.DictReader(f)
            for row in reader:
                try:
                    if int(row["user_id"]) != user_id:
                        continue
                    d = date.fromisoformat(row["date"])
                except (TypeError, ValueError, KeyError):
                    continue
                try:
                    calories = int(row["calories"])
                except (TypeError, ValueError):
                    calories = 0
                weight = None
                if row.get("weight"):
                    try:
                        weight = float(row["weight"])
                    except (TypeError, ValueError):
                        weight = None
                result.append(
                    DailyEntry(
                        date=d,
                        user_id=user_id,
                        username=row.get("username", ""),
                        calories=calories,
                        weight=weight,
                        exercises=row.get("exercises", ""),
                    )
                )
    except Exception as e:
        logger.error(f"Ошибка загрузки записей пользователя {user_id}: {e}")
    return result


def compute_deficit_with_history(
    profile: UserProfile,
    entries: List[DailyEntry],
) -> Dict[str, float]:
    """
    Расчёт дефицита:
    - по весу (объективно),
    - по калориям (накопленный дефицит),
    - прогноз по среднему дефициту за 7 дней.
    """
    kcal_per_kg = 7700
    start = profile.start_weight if profile.start_weight else profile.current_weight

    total_deficit_needed = max(0.0, (start - profile.target_weight)) * kcal_per_kg
    deficit_achieved_weight = max(0.0, (start - profile.current_weight)) * kcal_per_kg

    # Калории по дням
    daily_cals: Dict[date, int] = defaultdict(int)
    for e in entries:
        if e.user_id != profile.user_id:
            continue
        daily_cals[e.date] += e.calories

    tdee = profile.calculate_tdee()
    bmr = profile.calculate_bmr()

    today = date.today()
    today_calories = daily_cals.get(today, 0)
    daily_deficit_today = max(0.0, tdee - today_calories)

    # Накопленный дефицит по калориям за всё время
    deficit_achieved_calories = 0.0
    for d, cals in daily_cals.items():
        day_def = max(0.0, tdee - cals)
        deficit_achieved_calories += day_def

    # Эффективно засчитываем максимум из «по весу» и «по калориям»
    deficit_achieved_effective = max(deficit_achieved_weight, deficit_achieved_calories)
    deficit_remaining = max(0.0, total_deficit_needed - deficit_achieved_effective)

    # Средний дефицит за последние 7 дней (включая сегодня),
    # но считаем только по дням, где есть записи по калориям.
    total_def_7 = 0.0
    days_counted = 0
    for i in range(7):
        d = today - timedelta(days=i)
        if d in daily_cals:
            cals = daily_cals[d]
            day_def = max(0.0, tdee - cals)
            total_def_7 += day_def
            days_counted += 1

    if days_counted:
        avg_daily_def_7d = total_def_7 / days_counted
    else:
        # Если записей вообще нет, ориентируемся на плановый дефицит (TDEE - лимит),
        # а не на нереалистичный вариант «сегодня ничего не ел».
        planned_deficit = max(0.0, tdee - profile.calorie_limit)
        avg_daily_def_7d = planned_deficit

    days_to_goal = deficit_remaining / avg_daily_def_7d if avg_daily_def_7d > 0 else float("inf")

    return {
        "total_deficit_needed": total_deficit_needed,
        "deficit_achieved_weight": deficit_achieved_weight,
        "deficit_achieved_calories": deficit_achieved_calories,
        "deficit_achieved_effective": deficit_achieved_effective,
        "deficit_remaining": deficit_remaining,
        "daily_deficit_today": daily_deficit_today,
        "avg_daily_deficit_7d": avg_daily_def_7d,
        "days_to_goal": days_to_goal,
        "tdee": tdee,
        "bmr": bmr,
        "today_calories": today_calories,
    }


# --- Построение календаря ---

def build_calendar_image(
        *,
        year: int,
        month: int,
        users: Dict[int, UserProfile],
        entries: List[DailyEntry],
        personal_user_id: Optional[int] = None,
) -> Path:
    cal = calendar.Calendar(firstweekday=0)
    month_days = [d for d in cal.itermonthdates(year, month) if d.month == month]

    daily_user_calories: Dict[date, Dict[int, int]] = {d: {} for d in month_days}

    for e in entries:
        if e.date in daily_user_calories and e.calories > 0:
            if e.user_id not in daily_user_calories[e.date]:
                daily_user_calories[e.date][e.user_id] = 0
            daily_user_calories[e.date][e.user_id] += e.calories

    weeks = calendar.monthcalendar(year, month)
    n_weeks = len(weeks)
    fig, ax = plt.subplots(figsize=(14, 2.2 + 1.6 * n_weeks))

    for week_idx, week in enumerate(weeks):
        for dow_idx, day_num in enumerate(week):
            if day_num == 0:
                continue
            d = date(year, month, day_num)

            has_any_data = any(daily_user_calories[d].values())
            cell_bg = "#FFFFFF" if has_any_data else "#FAFAFA"
            rect = plt.Rectangle(
                (dow_idx, n_weeks - week_idx - 1),
                1, 1,
                facecolor=cell_bg,
                edgecolor="#E0E0E0",
                linewidth=0.5
            )
            ax.add_patch(rect)

            ax.text(
                dow_idx + 0.02,
                n_weeks - week_idx - 0.15,
                str(day_num),
                ha="left", va="top",
                fontsize=10, color="#666666", weight="bold"
            )

            user_cals = daily_user_calories[d]

            if personal_user_id is not None:
                total = user_cals.get(personal_user_id, 0)
                user = users.get(personal_user_id)
                limit = user.calorie_limit if user else 0

                if total > 0:
                    if total <= limit * 0.8:
                        bg_color = "#C8E6C9"
                        text_color = "#2E7D32"
                    elif total <= limit:
                        bg_color = "#FFF9C4"
                        text_color = "#F57F17"
                    else:
                        bg_color = "#FFCDD2"
                        text_color = "#C62828"

                    box_w, box_h = 0.9, 0.5
                    # ✅ Исправлено: используем FancyBboxPatch вместо Rectangle
                    box = FancyBboxPatch(
                        (dow_idx + 0.05, n_weeks - week_idx - 0.9),
                        box_w, box_h,
                        facecolor=bg_color, edgecolor="none",
                        boxstyle="round,pad=0.1",
                        mutation_aspect=0.5
                    )
                    ax.add_patch(box)
                    ax.text(
                        dow_idx + 0.5,
                        n_weeks - week_idx - 0.65,
                        f"{total}",
                        ha="center", va="center",
                        fontsize=11, color=text_color, weight="bold"
                    )
            else:
                if user_cals:
                    sorted_users = sorted(
                        user_cals.items(),
                        key=lambda x: x[1],
                        reverse=True
                    )
                    max_display = 3
                    to_show = sorted_users[:max_display]
                    hidden_count = len(sorted_users) - max_display

                    y_start = n_weeks - week_idx - 0.35
                    line_height = 0.22

                    for i, (uid, cals) in enumerate(to_show):
                        user = users.get(uid)
                        username = user.username if user and user.username else f"user_{uid}"
                        limit = user.calorie_limit if user else 2000

                        if cals <= limit * 0.8:
                            status_color = "#4CAF50"
                        elif cals <= limit:
                            status_color = "#FFC107"
                        else:
                            status_color = "#F44336"

                        display_text = f"@{username[:8]}: {cals}"

                        ax.text(
                            dow_idx + 0.03,
                            y_start - i * line_height,
                            display_text,
                            ha="left", va="center",
                            fontsize=8,
                            color=status_color if cals > limit else "#333333",
                            weight="bold" if cals > limit else "normal",
                            bbox=dict(boxstyle="round,pad=0.15", facecolor="#FFFFFF80", edgecolor="none")
                        )

                    if hidden_count > 0:
                        ax.text(
                            dow_idx + 0.03,
                            y_start - len(to_show) * line_height,
                            f"…ещё {hidden_count}",
                            ha="left", va="center",
                            fontsize=7, color="#999999",
                            style="italic"
                        )

    ax.set_xlim(0, 7)
    ax.set_ylim(0, n_weeks)
    ax.set_xticks(range(7))
    ax.set_xticklabels(["Пн", "Вт", "Ср", "Чт", "Пт", "Сб", "Вс"], fontsize=9)
    ax.set_yticks([])

    if personal_user_id is None:
        legend_text = "🟢 в норме  🟡 на грани  🔴 перебор"
        ax.text(
            3.5, -0.4, legend_text,
            ha="center", va="center",
            fontsize=8, color="#666666",
            bbox=dict(boxstyle="round,pad=0.3", facecolor="#F5F5F5", edgecolor="#DDD")
        )

    month_name = calendar.month_name[month].capitalize()
    title = f"{'Личная' if personal_user_id else 'Общая'} статистика — {month_name} {year}"
    ax.set_title(title, fontsize=13, pad=20)
    ax.axis("off")
    fig.tight_layout()

    filename = (
        f"personal_{personal_user_id}_{year}_{month}.png"
        if personal_user_id
        else f"global_{year}_{month}.png"
    )
    path = CALENDAR_DIR / filename
    fig.savefig(path, dpi=150, bbox_inches='tight')
    plt.close(fig)
    return path


# --- Telegram-бот ---

(
    ONBOARD_WEIGHT, ONBOARD_TARGET, ONBOARD_LIMIT,
    ONBOARD_HEIGHT, ONBOARD_AGE, ONBOARD_GENDER, ONBOARD_ACTIVITY,
    ADD_CALORIES, UPDATE_WEIGHT,
    STATS_SCOPE, STATS_MONTH_SELECT,
    SETTINGS_CHOICE, SETTINGS_NEW_TARGET, SETTINGS_NEW_LIMIT,
    SETTINGS_EDIT_BIOMETRICS, SETTINGS_EDIT_ACTIVITY,
) = range(16)

MAIN_MENU_KEYBOARD = ReplyKeyboardMarkup(
    [
        ["🍔 Добавить калории", "⚖️ Обновить вес"],
        ["📊 Мой статус", "📅 Статистика"],
        ["⚙️ Настройки", "⚡ Получить заряд бодрости"],
    ],
    resize_keyboard=True,
)

STATS_SCOPE_KEYBOARD = ReplyKeyboardMarkup(
    [["👤 Моя статистика"], ["🌍 Общая статистика"], ["❌ Отмена"]],
    resize_keyboard=True,
)

SETTINGS_KEYBOARD = ReplyKeyboardMarkup(
    [["🎯 Изменить цель (вес)"], ["🔥 Изменить лимит (ккл)"],
     ["📏 Рост/возраст/пол"], ["🏃 Активность"], ["❌ Отмена"]],
    resize_keyboard=True,
)


def is_allowed(update: Update) -> bool:
    user = update.effective_user
    if not user or not user.username:
        return False
    allowed = user.username in ALLOWED_USERNAMES
    if not allowed:
        logger.warning(f"Попытка доступа от запрещенного пользователя: {user.username} ({user.id})")
    return allowed


async def deny_access(update: Update) -> None:
    if update.message:
        await update.message.reply_text("🚫 У тебя нет доступа к этому боту.")


async def start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        await deny_access(update)
        return ConversationHandler.END

    ensure_csv_files()
    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    logger.info(f"Команда /start от пользователя {tg_user.username}")

    if tg_user.id in users:
        profile = users[tg_user.id]
        all_entries = load_entries_for_user(tg_user.id)
        deficit = compute_deficit_with_history(profile, all_entries)
        await update.message.reply_text(
            f"С возвращением, {tg_user.first_name}!\n\n"
            f"⚖️ Вес: {profile.current_weight:.1f} кг (цель: {profile.target_weight:.1f})\n"
            f"🔥 Лимит: {profile.calorie_limit} ккал | TDEE: {deficit['tdee']:.0f} ккал\n"
            f"📉 Осталось сжечь: {format_ru_number(deficit['deficit_remaining'])} ккал\n"
            f"🏆 Звание: {profile.role.value}",
            reply_markup=MAIN_MENU_KEYBOARD,
        )
        return ConversationHandler.END

    await update.message.reply_text(
        "Привет! Это твой жирный помощник.\n"
        "Сначала настроим профиль.\n\n"
        "Введи текущий вес в кг (например: 83.5):",
        reply_markup=ReplyKeyboardRemove(),
    )
    return ONBOARD_WEIGHT


# --- ОНБОРДИНГ (ИСПРАВЛЕННЫЙ) ---

async def onboard_weight(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    try:
        weight = float(update.message.text.replace(",", "."))
        if weight <= 0:
            raise ValueError
    except (TypeError, ValueError):
        await update.message.reply_text("Не понял. Введи положительное число, например: 83.5")
        return ONBOARD_WEIGHT
    context.user_data["current_weight"] = weight
    context.user_data["start_weight"] = weight
    await update.message.reply_text("Ок. Теперь введи целевой вес в кг:")
    return ONBOARD_TARGET


async def onboard_target(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    try:
        weight = float(update.message.text.replace(",", "."))
        if weight <= 0:
            raise ValueError
    except (TypeError, ValueError):
        await update.message.reply_text("Не понял. Введи положительное число, например: 75")
        return ONBOARD_TARGET
    context.user_data["target_weight"] = weight
    await update.message.reply_text("Отлично. Теперь введи дневной лимит калорий (целое число):")
    return ONBOARD_LIMIT


async def onboard_limit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    try:
        limit = int(update.message.text)
        if limit <= 0:
            raise ValueError
    except (TypeError, ValueError):
        await update.message.reply_text("Не понял. Введи положительное целое число, например: 2200")
        return ONBOARD_LIMIT
    context.user_data["calorie_limit"] = limit
    await update.message.reply_text(
        "Теперь для расчёта метаболизма.\n"
        "Введи свой рост в см (например: 180):",
        reply_markup=ReplyKeyboardRemove(),
    )
    return ONBOARD_HEIGHT


async def onboard_height(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    try:
        height = int(update.message.text)
        if not 100 <= height <= 250:
            raise ValueError
        context.user_data["height_cm"] = height
    except (TypeError, ValueError):
        await update.message.reply_text("Рост должен быть числом от 100 до 250 см. Попробуй ещё раз:")
        return ONBOARD_HEIGHT

    # Сразу переходим к следующему шагу
    await update.message.reply_text("Введи возраст в годах (например: 28):")
    return ONBOARD_AGE


async def onboard_age(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    try:
        age = int(update.message.text)
        if not 10 <= age <= 100:
            raise ValueError
        context.user_data["age"] = age
    except (TypeError, ValueError):
        await update.message.reply_text("Возраст должен быть от 10 до 100 лет. Попробуй ещё раз:")
        return ONBOARD_AGE

    keyboard = ReplyKeyboardMarkup([["Мужской", "Женский"]], resize_keyboard=True)
    await update.message.reply_text("Выбери пол:", reply_markup=keyboard)
    return ONBOARD_GENDER


async def onboard_gender(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    text = update.message.text.strip().lower()
    if text in ["мужской", "м", "male"]:
        context.user_data["gender"] = "male"
    elif text in ["женский", "ж", "female"]:
        context.user_data["gender"] = "female"
    else:
        await update.message.reply_text("Выбери 'Мужской' или 'Женский' с клавиатуры.")
        return ONBOARD_GENDER

    keyboard = ReplyKeyboardMarkup([
        ["🪑 1.2", "🚶 1.375"],
        ["🏃 1.55", "🔥 1.725"],
        ["/skip"]
    ], resize_keyboard=True)
    await update.message.reply_text(
        "Выбери уровень активности:\n"
        "🪑 1.2 — сидячий (офис, без спорта)\n"
        "🚶 1.375 — лёгкая (тренировки 1-3 раза/нед)\n"
        "🏃 1.55 — средняя (3-5 раз/нед)\n"
        "🔥 1.725 — активная (ежедневно)\n"
        "Или /skip:",
        reply_markup=keyboard
    )
    return ONBOARD_ACTIVITY

def format_ru_number(num: float) -> str:
    """Форматирует число с пробелами как разделитель тысяч: 100100 → '100 100'"""
    return f"{int(num):,}".replace(",", " ")

async def onboard_activity(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END

    text = update.message.text.strip()
    activity_map = {
        "🪑 1.2": 1.2, "1.2": 1.2,
        "🚶 1.375": 1.375, "1.375": 1.375,
        "🏃 1.55": 1.55, "1.55": 1.55,
        "🔥 1.725": 1.725, "1.725": 1.725,
    }

    # Проверяем корректность ввода
    new_activity = activity_map.get(text, None)
    if new_activity is None:
        await update.message.reply_text(
            "Пожалуйста, выбери один из вариантов в меню:\n"
            "🪑 1.2 — сидячий\n"
            "🚶 1.375 — лёгкая\n"
            "🏃 1.55 — средняя\n"
            "🔥 1.725 — активная"
        )
        return ONBOARD_ACTIVITY

    context.user_data["activity_level"] = new_activity

    # === ФИНАЛИЗАЦИЯ ОНБОРДИНГА (встроена напрямую) ===
    ensure_csv_files()
    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    profile = UserProfile(
        user_id=tg_user.id,
        username=tg_user.username or "",
        current_weight=context.user_data["current_weight"],
        target_weight=context.user_data["target_weight"],
        calorie_limit=context.user_data["calorie_limit"],
        height_cm=context.user_data.get("height_cm", 175),
        age=context.user_data.get("age", 30),
        gender=context.user_data.get("gender", "male"),
        activity_level=context.user_data.get("activity_level", 1.375),
        start_weight=context.user_data.get("start_weight"),
    )
    users[tg_user.id] = profile
    save_users(users)

    # На старте используем чисто расчётный дефицит (по весу ещё рано судить)
    base_deficit = profile.get_deficit_progress()
    days_forecast = (
        f"~{base_deficit['days_to_goal']:.0f} дней"
        if base_deficit["daily_deficit"] > 0
        else "❌ Нет дефицита"
    )

    logger.info(
        f"Новый пользователь: {tg_user.username}, "
        f"BMR={base_deficit['bmr']:.0f}, TDEE={base_deficit['tdee']:.0f}"
    )

    await update.message.reply_text(
        f"✅ Профиль готов!\n\n"
        f"🔥 Твой метаболизм:\n"
        f"   BMR (покой): {base_deficit['bmr']:.0f} ккал/день\n"
        f"   TDEE (с активностью): {base_deficit['tdee']:.0f} ккал/день\n\n"
        f"🎯 Для цели нужно сжечь: {format_ru_number(base_deficit['total_deficit_needed'])} ккал\n"
        f"📊 При лимите {profile.calorie_limit} ккал/день:\n"
        f"   Ежедневный дефицит: ~{base_deficit['daily_deficit']:.0f} ккал\n"
        f"   Прогноз до цели: {days_forecast}\n\n"
        f"🏆 Звание: {profile.role.value}",
        reply_markup=MAIN_MENU_KEYBOARD,
    )
    return ConversationHandler.END


async def _finalize_onboarding(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    ensure_csv_files()
    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    profile = UserProfile(
        user_id=tg_user.id,
        username=tg_user.username or "",
        current_weight=context.user_data["current_weight"],
        target_weight=context.user_data["target_weight"],
        calorie_limit=context.user_data["calorie_limit"],
        height_cm=context.user_data.get("height_cm", 175),
        age=context.user_data.get("age", 30),
        gender=context.user_data.get("gender", "male"),
        activity_level=context.user_data.get("activity_level", 1.375),
        start_weight=context.user_data.get("start_weight"),
    )
    users[tg_user.id] = profile
    save_users(users)

    deficit = profile.get_deficit_progress()
    days_forecast = f"~{deficit['days_to_goal']:.0f} дней" if deficit['daily_deficit'] > 0 else "❌ Нет дефицита"

    logger.info(f"Новый пользователь: {tg_user.username}, BMR={deficit['bmr']:.0f}, TDEE={deficit['tdee']:.0f}")

    await update.message.reply_text(
        f"✅ Профиль готов!\n\n"
        f"🔥 Твой метаболизм:\n"
        f"   BMR (покой): {deficit['bmr']:.0f} ккал/день\n"
        f"   TDEE (с активностью): {deficit['tdee']:.0f} ккал/день\n\n"
        f"🎯 Для цели нужно сжечь: {format_ru_number(deficit['total_deficit_needed'])} ккал\n"
        f"📊 При лимите {profile.calorie_limit} ккал/день:\n"
        f"   Ежедневный дефицит: ~{format_ru_number(deficit['daily_deficit'])} ккал\n"
        f"   Прогноз до цели: {days_forecast}\n\n"
        f"🏆 Звание: {profile.role.value}",
        reply_markup=MAIN_MENU_KEYBOARD,
    )
    return ConversationHandler.END


# --- Калории ---

async def add_calories_entry(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    await update.message.reply_text("Сколько калорий в этом приёме пищи? (число суммируется к сегодняшнему):")
    return ADD_CALORIES


async def handle_add_calories(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    try:
        calories = int(update.message.text)
        if calories < 0:
            raise ValueError
    except (TypeError, ValueError):
        await update.message.reply_text("Введи положительное целое число.")
        return ADD_CALORIES

    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    if tg_user.id not in users:
        await update.message.reply_text("Сначала введи профиль командой /start.")
        return ConversationHandler.END

    entry = DailyEntry(date=date.today(), user_id=tg_user.id, username=tg_user.username or "", calories=calories)
    append_or_update_entry(entry)
    logger.info(f"User {tg_user.username} added {calories} kcal")

    profile = users[tg_user.id]
    # Пересчитываем дефицит с учётом всей истории и сегодняшних калорий
    all_entries = load_entries_for_user(tg_user.id)
    deficit = compute_deficit_with_history(profile, all_entries)
    insult = get_bad_phrase()
    await update.message.reply_text(
        f"Записал +{calories} ккал.\n"
        f"{insult}\n"
        f"Осталось сжечь до цели: {format_ru_number(deficit['deficit_remaining'])} ккал",
        reply_markup=MAIN_MENU_KEYBOARD,
    )

    # Если уже превысил лимит по калориям — отдельная «наградная» фраза
    today_cals = int(deficit["today_calories"])
    if today_cals > profile.calorie_limit:
        await update.message.reply_text("АХАХАХА ну ты и лох, жри дальше.")

    return ConversationHandler.END


# --- Вес ---

async def update_weight_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    await update.message.reply_text("Введи новый текущий вес в кг:")
    return UPDATE_WEIGHT


async def handle_update_weight(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    try:
        weight = float(update.message.text.replace(",", "."))
        if weight <= 0:
            raise ValueError
    except (TypeError, ValueError):
        await update.message.reply_text("Введи положительное число.")
        return UPDATE_WEIGHT

    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    if tg_user.id not in users:
        await update.message.reply_text("Сначала введи профиль командой /start.")
        return ConversationHandler.END

    profile = users[tg_user.id]
    old_weight = profile.current_weight
    profile.current_weight = weight
    save_users(users)
    logger.info(f"User {tg_user.username} updated weight: {old_weight} -> {weight}")

    entry = DailyEntry(date=date.today(), user_id=tg_user.id, username=tg_user.username or "", calories=0,
                       weight=weight)
    append_or_update_entry(entry)

    # Пересчитываем метаболизм с новым весом
    deficit = profile.get_deficit_progress()

    await update.message.reply_text(
        f"⚖️ Вес обновлен: {old_weight:.1f} ➡️ {weight:.1f} кг\n\n"
        f"🔥 Метаболизм пересчитан:\n"
        f"   BMR: {deficit['bmr']:.0f} ккал/день\n"
        f"   TDEE: {deficit['tdee']:.0f} ккал/день\n\n"
        f"📉 Осталось сжечь: {format_ru_number(deficit['deficit_remaining'])} ккал\n"
        f"🏆 Звание: {profile.role.value}",
        reply_markup=MAIN_MENU_KEYBOARD,
    )
    return ConversationHandler.END


# --- Статус ---

async def show_status(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END

    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    if tg_user.id not in users:
        await update.message.reply_text("Профиль не найден. Используйте /start")
        return ConversationHandler.END

    profile = users[tg_user.id]
    all_entries = load_entries_for_user(tg_user.id)
    deficit = compute_deficit_with_history(profile, all_entries)
    today_calories = int(deficit["today_calories"])

    if deficit["avg_daily_deficit_7d"] > 0 and deficit["deficit_remaining"] > 0:
        days_forecast = f"~{deficit['days_to_goal']:.0f} дней"
    elif deficit["deficit_remaining"] <= 0:
        days_forecast = "🎉 Цель достигнута!"
    else:
        days_forecast = "❌ Дефицита нет (лимит ≥ расход)"

    total = deficit["total_deficit_needed"]
    achieved_effective = deficit["deficit_achieved_effective"]
    if total > 0:
        pct = min(100, achieved_effective / total * 100)
        bar_len = 20
        filled = int(bar_len * pct / 100)
        progress_bar = "█" * filled + "░" * (bar_len - filled)
        progress_text = f"[{progress_bar}] {pct:.1f}%"
    else:
        progress_text = "─" * 22 + " 100%"

    text = (
        f"📊 *Статус на {date.today().strftime('%d.%m.%Y')}*\n\n"
        f"🔥 *Баланс калорий*:\n"
        f"   Потреблено сегодня: {today_calories} ккал\n"
        f"   TDEE (расход): {deficit['tdee']:.0f} ккал\n"
        f"   Дефицит за сегодня: *{deficit['daily_deficit_today']:.0f} ккал*\n\n"
        f"🎯 *Путь к цели*:\n"
        f"   Всего нужно сжечь: {format_ru_number(deficit['total_deficit_needed'])} ккал\n"
        f"   ✅ Уже сжжено по весу: {format_ru_number(deficit['deficit_achieved_weight'])} ккал\n"
        f"   📉 Уже сжжено по калориям: {format_ru_number(deficit['deficit_achieved_calories'])} ккал\n"
        f"   🔥 В зачёт идёт: {format_ru_number(deficit['deficit_achieved_effective'])} ккал\n"
        f"   Осталось сжечь: {format_ru_number(deficit['deficit_remaining'])} ккал\n"
        f"   🗓️ Прогноз (по среднему дефициту 7 дней): {days_forecast}\n\n"
        f"📈 Прогресс: {progress_text}"
    )
    await update.message.reply_text(text, reply_markup=MAIN_MENU_KEYBOARD, parse_mode="Markdown")
    return ConversationHandler.END


# --- Статистика с inline-кнопками ---

async def stats_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    await update.message.reply_text("Что показать?", reply_markup=STATS_SCOPE_KEYBOARD)
    return STATS_SCOPE


async def stats_scope_choose(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END

    text = update.message.text.strip().lower()
    if "моя" in text or "👤" in text:
        context.user_data["stats_scope"] = "personal"
        user_id = update.effective_user.id
    elif "общая" in text or "🌍" in text:
        context.user_data["stats_scope"] = "global"
        user_id = None
    else:
        await update.message.reply_text("Ок, отмена.", reply_markup=MAIN_MENU_KEYBOARD)
        return ConversationHandler.END

    available_months = get_available_months(user_id=user_id)

    if not available_months:
        await update.message.reply_text(
            "📭 Пока нет данных для отображения.\n"
            "Добавь калории или вес, чтобы появилась статистика.",
            reply_markup=MAIN_MENU_KEYBOARD
        )
        return ConversationHandler.END

    keyboard = []
    current_year = None

    today = date.today()
    keyboard.append([
        InlineKeyboardButton(
            f"📅 Текущий ({today.month:02d}.{today.year})",
            callback_data=f"stats_{today.year}_{today.month:02d}"
        )
    ])
    keyboard.append([InlineKeyboardButton("──────────────", callback_data="ignore")])

    for year, month in available_months[:12]:
        if year != current_year:
            current_year = year
            keyboard.append([InlineKeyboardButton(f"📆 {year}", callback_data="ignore")])

        month_name = calendar.month_name[month].capitalize()
        keyboard.append([
            InlineKeyboardButton(
                f"{month_name} {year}",
                callback_data=f"stats_{year}_{month:02d}"
            )
        ])

    if len(available_months) > 12:
        keyboard.append([
            InlineKeyboardButton("◀️ Больше месяцев", callback_data="stats_more_12")
        ])

    keyboard.append([InlineKeyboardButton("❌ Отмена", callback_data="stats_cancel")])

    await update.message.reply_text(
        f"📊 Выбери месяц для просмотра статистики:\n"
        f"Всего доступно: {len(available_months)} мес.",
        reply_markup=InlineKeyboardMarkup(keyboard)
    )
    return STATS_MONTH_SELECT


async def stats_month_callback(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    query = update.callback_query
    await query.answer()

    data = query.data

    if data == "stats_cancel":
        await query.edit_message_text("Отмена.", reply_markup=None)
        await query.message.reply_text("Главное меню:", reply_markup=MAIN_MENU_KEYBOARD)
        return ConversationHandler.END

    if data == "ignore":
        return STATS_MONTH_SELECT

    if data.startswith("stats_more_"):
        await query.answer("Показаны все доступные месяцы выше ⬆️")
        return STATS_MONTH_SELECT

    try:
        parts = data.replace("stats_", "").split("_")
        year = int(parts[0])
        month = int(parts[1])
    except (ValueError, IndexError):
        await query.answer("❌ Ошибка формата даты")
        return STATS_MONTH_SELECT

    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    scope = context.user_data.get("stats_scope", "personal")

    try:
        if scope == "personal":
            entries = load_entries_for_month(year, month, user_id=tg_user.id)
            img_path = build_calendar_image(
                year=year, month=month, users=users,
                entries=entries, personal_user_id=tg_user.id
            )
            title = "👤 Твоя статистика"
        else:
            entries = load_entries_for_month(year, month, user_id=None)
            img_path = build_calendar_image(
                year=year, month=month, users=users,
                entries=entries, personal_user_id=None
            )
            title = "🌍 Общая статистика"

        month_name = calendar.month_name[month].capitalize()

        with img_path.open("rb") as f:
            await query.message.reply_photo(
                photo=InputFile(f),
                caption=f"{title} за {month_name} {year}",
                reply_markup=MAIN_MENU_KEYBOARD
            )

        await query.edit_message_text(
            f"✅ Отправлена статистика за {month_name} {year}",
            reply_markup=None
        )

    except Exception as e:
        logger.error(f"Ошибка генерации календаря: {e}")
        await query.answer("❌ Ошибка при построении графика")

    return ConversationHandler.END


# --- Настройки ---

async def settings_start(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if not is_allowed(update):
        return ConversationHandler.END
    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None
    if tg_user.id not in users:
        await update.message.reply_text("Сначала создай профиль через /start")
        return ConversationHandler.END

    await update.message.reply_text("Что хотите изменить?", reply_markup=SETTINGS_KEYBOARD)
    return SETTINGS_CHOICE


async def settings_choice(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    text = update.message.text.strip()
    if "цель" in text.lower():
        await update.message.reply_text("Введи новый целевой вес (кг):", reply_markup=ReplyKeyboardRemove())
        return SETTINGS_NEW_TARGET
    elif "лимит" in text.lower():
        await update.message.reply_text("Введи новый лимит калорий:", reply_markup=ReplyKeyboardRemove())
        return SETTINGS_NEW_LIMIT
    elif "рост" in text.lower() or "возраст" in text.lower() or "пол" in text.lower():
        users = load_users()
        profile = users.get(update.effective_user.id)
        if profile:
            await update.message.reply_text(
                f"Текущие параметры:\n"
                f"📏 Рост: {profile.height_cm} см\n"
                f"🎂 Возраст: {profile.age} лет\n"
                f"👤 Пол: {'Мужской' if profile.gender == 'male' else 'Женский'}\n\n"
                f"Введи новые данные в формате: `рост возраст пол`\n"
                f"Пример: `180 28 male`",
                reply_markup=ReplyKeyboardRemove(),
            )
        return SETTINGS_EDIT_BIOMETRICS
    elif "актив" in text.lower():
        keyboard = ReplyKeyboardMarkup([
            ["🪑 1.2", "🚶 1.375"],
            ["🏃 1.55", "🔥 1.725"],
            ["❌ Отмена"]
        ], resize_keyboard=True)
        await update.message.reply_text("Выбери уровень активности:", reply_markup=keyboard)
        return SETTINGS_EDIT_ACTIVITY
    else:
        await update.message.reply_text("Отмена.", reply_markup=MAIN_MENU_KEYBOARD)
        return ConversationHandler.END


async def settings_new_target(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        weight = float(update.message.text.replace(",", "."))
        if weight <= 0:
            raise ValueError
    except:
        await update.message.reply_text("Ошибка. Введи положительное число.")
        return SETTINGS_NEW_TARGET

    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    if tg_user.id not in users:
        return ConversationHandler.END

    profile = users[tg_user.id]
    old_target = profile.target_weight
    profile.target_weight = weight
    save_users(users)
    logger.info(f"User {tg_user.username} changed target: {old_target} -> {weight}")

    # Для оценки остатка используем историю калорий, если она есть
    all_entries = load_entries_for_user(tg_user.id)
    deficit = compute_deficit_with_history(profile, all_entries)
    await update.message.reply_text(
        f"Цель изменена: {old_target:.1f} ➡️ {weight:.1f} кг\n"
        f"Осталось сжечь: {format_ru_number(deficit['deficit_remaining'])} ккал",
        reply_markup=MAIN_MENU_KEYBOARD,
    )
    return ConversationHandler.END


async def settings_new_limit(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        limit = int(update.message.text)
        if limit <= 0:
            raise ValueError
    except:
        await update.message.reply_text("Ошибка. Введи положительное целое число.")
        return SETTINGS_NEW_LIMIT

    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    if tg_user.id not in users:
        return ConversationHandler.END

    profile = users[tg_user.id]
    old_limit = profile.calorie_limit
    profile.calorie_limit = limit
    save_users(users)
    logger.info(f"User {tg_user.username} changed limit: {old_limit} -> {limit}")

    # Обновляем прогноз с учётом среднего дефицита за 7 дней
    all_entries = load_entries_for_user(tg_user.id)
    deficit = compute_deficit_with_history(profile, all_entries)
    days_forecast = (
        f"~{deficit['days_to_goal']:.0f} дней"
        if deficit['avg_daily_deficit_7d'] > 0 and deficit['deficit_remaining'] > 0
        else ("🎉 Цель достигнута!" if deficit['deficit_remaining'] <= 0 else "❌ Нет дефицита")
    )

    await update.message.reply_text(
        f"Лимит изменен: {old_limit} ➡️ {limit} ккал\n"
        f"Средний дефицит за 7 дней: {deficit['avg_daily_deficit_7d']:.0f} ккал/день\n"
        f"Прогноз: {days_forecast}",
        reply_markup=MAIN_MENU_KEYBOARD,
    )
    return ConversationHandler.END


async def settings_edit_biometrics(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    try:
        parts = update.message.text.strip().split()
        if len(parts) != 3:
            raise ValueError
        height = int(parts[0])
        age = int(parts[1])
        gender = parts[2].lower()
        if gender not in ["male", "female", "м", "ж"]:
            raise ValueError
        if gender in ["м", "ж"]:
            gender = "male" if gender == "м" else "female"
    except:
        await update.message.reply_text("Ошибка. Формат: `рост возраст пол`\nПример: `180 28 male`")
        return SETTINGS_EDIT_BIOMETRICS

    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    if tg_user.id not in users:
        return ConversationHandler.END

    profile = users[tg_user.id]
    profile.height_cm = height
    profile.age = age
    profile.gender = gender
    save_users(users)
    logger.info(f"User {tg_user.username} updated biometrics: {height}cm, {age}yo, {gender}")

    all_entries = load_entries_for_user(tg_user.id)
    deficit = compute_deficit_with_history(profile, all_entries)
    await update.message.reply_text(
        f"Параметры обновлены:\n"
        f"📏 Рост: {height} см\n"
        f"🎂 Возраст: {age} лет\n"
        f"👤 Пол: {'Мужской' if gender == 'male' else 'Женский'}\n\n"
        f"🔥 Новый метаболизм:\n"
        f"   BMR: {deficit['bmr']:.0f} ккал/день\n"
        f"   TDEE: {deficit['tdee']:.0f} ккал/день\n"
        f"   Средний дефицит за 7 дней: {deficit['avg_daily_deficit_7d']:.0f} ккал/день",
        reply_markup=MAIN_MENU_KEYBOARD,
    )
    return ConversationHandler.END


async def settings_edit_activity(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    text = update.message.text.strip()
    activity_map = {
        "🪑 1.2": 1.2, "1.2": 1.2,
        "🚶 1.375": 1.375, "1.375": 1.375,
        "🏃 1.55": 1.55, "1.55": 1.55,
        "🔥 1.725": 1.725, "1.725": 1.725,
    }

    if text.lower() in ["отмена", "❌ отмена", "cancel"]:
        await update.message.reply_text("Отмена.", reply_markup=MAIN_MENU_KEYBOARD)
        return ConversationHandler.END

    new_activity = activity_map.get(text, None)
    if new_activity is None:
        await update.message.reply_text("Выбери одно из значений в меню.")
        return SETTINGS_EDIT_ACTIVITY

    users = load_users()
    tg_user = update.effective_user
    assert tg_user is not None

    if tg_user.id not in users:
        return ConversationHandler.END

    profile = users[tg_user.id]
    old_activity = profile.activity_level
    profile.activity_level = new_activity
    save_users(users)
    logger.info(f"User {tg_user.username} updated activity: {old_activity} -> {new_activity}")

    all_entries = load_entries_for_user(tg_user.id)
    deficit = compute_deficit_with_history(profile, all_entries)
    await update.message.reply_text(
        f"Активность изменена: {old_activity} ➡️ {new_activity}\n"
        f"🔥 Новый метаболизм:\n"
        f"   BMR: {deficit['bmr']:.0f} ккал/день\n"
        f"   TDEE: {deficit['tdee']:.0f} ккал/день\n"
        f"   Средний дефицит за 7 дней: {deficit['avg_daily_deficit_7d']:.0f} ккал/день",
        reply_markup=MAIN_MENU_KEYBOARD,
    )
    return ConversationHandler.END


async def cancel(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    if update.message:
        await update.message.reply_text("Отменено.", reply_markup=MAIN_MENU_KEYBOARD)
    return ConversationHandler.END


async def help_command(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Краткая справка по боту и расчётам."""
    if not is_allowed(update):
        return
    text = (
        "🧠 Как считает бот:\n"
        "- *По весу*: сколько кг ты уже сбросил, × 7 700 ккал → «уже сжжено по весу».\n"
        "- *По калориям*: по каждому дню считает: TDEE − съеденные ккал (если в минусе — 0) "
        "и копит это как «уже сжжено по калориям».\n"
        "- В зачёт идёт максимум из этих двух величин.\n"
        "- Прогноз дней до цели считается по *среднему дефициту за последние 7 дней*.\n\n"
        "Команды:\n"
        "/start — создать или показать профиль\n"
        "/add — добавить калории\n"
        "/weight — обновить вес\n"
        "/status — текущий статус и прогресс\n"
        "/stats — календарь со статистикой\n"
        "/settings — настройки цели, лимита и параметров\n"
        "/help — эта справка"
    )
    await update.message.reply_text(text, parse_mode="Markdown", reply_markup=MAIN_MENU_KEYBOARD)


async def calories_reminder_job(context: ContextTypes.DEFAULT_TYPE) -> None:
    """Периодическое напоминание внести калории (для всех известных пользователей)."""
    try:
        users = load_users()
        if not users:
            return
        for user_id, profile in users.items():
            insult = get_bad_phrase()
            try:
                await context.bot.send_message(
                    chat_id=user_id,
                    text=(
                        "🕒 Напоминание внести калории за сегодня.\n"
                        "Зайди в бота и нажми «🍔 Добавить калории».\n\n"
                        f"{insult}"
                    ),
                )
            except Exception as e:
                logger.warning(f"Не удалось отправить напоминание пользователю {profile.username} ({user_id}): {e}")
    except Exception as e:
        logger.error(f"Ошибка в задаче напоминаний: {e}")


async def send_energy(update: Update, context: ContextTypes.DEFAULT_TYPE) -> int:
    """Отправляет случайную колкую фразу из BAD_LIST."""
    if not is_allowed(update):
        return ConversationHandler.END
    insult = get_bad_phrase()
    if not insult:
        await update.message.reply_text("Сегодня без подколов, но калории всё равно запиши.", reply_markup=MAIN_MENU_KEYBOARD)
    else:
        await update.message.reply_text(insult, reply_markup=MAIN_MENU_KEYBOARD)
    return ConversationHandler.END

from telegram.error import TimedOut, NetworkError
from httpcore import ConnectTimeout

async def error_handler(update: Update, context: ContextTypes.DEFAULT_TYPE) -> None:
    """Глобальный обработчик ошибок"""
    logger.error(f"Ошибка при обработке обновления: {context.error}")

    if isinstance(context.error, (TimedOut, NetworkError, ConnectTimeout)):
        logger.warning("Проблемы с соединением Telegram API (таймаут)")
        return

    if update and update.effective_message:
        await update.effective_message.reply_text(
            "⚠️ Произошла ошибка. Попробуйте позже."
        )
def build_application() -> "ApplicationBuilder":
    token = os.getenv("TELEGRAM_BOT_TOKEN")
    if not token:
        raise RuntimeError("Не задан TELEGRAM_BOT_TOKEN в переменных окружения.")

    app = ApplicationBuilder().token(token).build()

    # ✅ Добавь обработчик ошибок!
    app.add_error_handler(error_handler)

    onboard_conv = ConversationHandler(
        entry_points=[CommandHandler("start", start)],
        states={
            ONBOARD_WEIGHT: [MessageHandler(filters.TEXT & ~filters.COMMAND, onboard_weight)],
            ONBOARD_TARGET: [MessageHandler(filters.TEXT & ~filters.COMMAND, onboard_target)],
            ONBOARD_LIMIT: [MessageHandler(filters.TEXT & ~filters.COMMAND, onboard_limit)],
            ONBOARD_HEIGHT: [MessageHandler(filters.TEXT & ~filters.COMMAND, onboard_height)],
            ONBOARD_AGE: [MessageHandler(filters.TEXT & ~filters.COMMAND, onboard_age)],
            ONBOARD_GENDER: [MessageHandler(filters.TEXT & ~filters.COMMAND, onboard_gender)],
            ONBOARD_ACTIVITY: [MessageHandler(filters.TEXT & ~filters.COMMAND, onboard_activity)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    add_cal_conv = ConversationHandler(
        entry_points=[
            CommandHandler("add", add_calories_entry),
            MessageHandler(filters.TEXT & ~filters.COMMAND & filters.Regex("^🍔 Добавить калории$"), add_calories_entry),
        ],
        states={ADD_CALORIES: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_add_calories)]},
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    update_weight_conv = ConversationHandler(
        entry_points=[
            CommandHandler("weight", update_weight_start),
            MessageHandler(filters.TEXT & ~filters.COMMAND & filters.Regex("^⚖️ Обновить вес$"), update_weight_start),
        ],
        states={UPDATE_WEIGHT: [MessageHandler(filters.TEXT & ~filters.COMMAND, handle_update_weight)]},
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    app.add_handler(CommandHandler("status", show_status))
    app.add_handler(MessageHandler(filters.TEXT & ~filters.COMMAND & filters.Regex("^📊 Мой статус$"), show_status))

    stats_conv = ConversationHandler(
        entry_points=[
            CommandHandler("stats", stats_start),
            MessageHandler(filters.TEXT & ~filters.COMMAND & filters.Regex("^📅 Статистика$"), stats_start),
        ],
        states={
            STATS_SCOPE: [MessageHandler(filters.TEXT & ~filters.COMMAND, stats_scope_choose)],
            STATS_MONTH_SELECT: [CallbackQueryHandler(stats_month_callback)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    settings_conv = ConversationHandler(
        entry_points=[
            CommandHandler("settings", settings_start),
            MessageHandler(filters.TEXT & ~filters.COMMAND & filters.Regex("^⚙️ Настройки$"), settings_start),
        ],
        states={
            SETTINGS_CHOICE: [MessageHandler(filters.TEXT & ~filters.COMMAND, settings_choice)],
            SETTINGS_NEW_TARGET: [MessageHandler(filters.TEXT & ~filters.COMMAND, settings_new_target)],
            SETTINGS_NEW_LIMIT: [MessageHandler(filters.TEXT & ~filters.COMMAND, settings_new_limit)],
            SETTINGS_EDIT_BIOMETRICS: [MessageHandler(filters.TEXT & ~filters.COMMAND, settings_edit_biometrics)],
            SETTINGS_EDIT_ACTIVITY: [MessageHandler(filters.TEXT & ~filters.COMMAND, settings_edit_activity)],
        },
        fallbacks=[CommandHandler("cancel", cancel)],
    )

    app.add_handler(onboard_conv)
    app.add_handler(add_cal_conv)
    app.add_handler(update_weight_conv)
    app.add_handler(stats_conv)
    app.add_handler(settings_conv)
    app.add_handler(CommandHandler("cancel", cancel))
    app.add_handler(CommandHandler("help", help_command))
    app.add_handler(CommandHandler("energy", send_energy))
    app.add_handler(
        MessageHandler(
            filters.TEXT & ~filters.COMMAND & filters.Regex("^⚡ Получить заряд бодрости$"),
            send_energy,
        )
    )

    # Планировщик напоминаний: каждый день в 15:00 и 22:00 по Москве
    job_queue = app.job_queue
    if job_queue is None:
        logger.warning(
            "JobQueue недоступен (установите python-telegram-bot с extra 'job-queue', "
            "или проверьте окружение), напоминания о калориях работать не будут."
        )
    else:
        job_queue.run_daily(
            calories_reminder_job,
            time=dtime(hour=15, minute=14, tzinfo=MOSCOW_TZ),
            name="calories_reminder_15",
        )
        job_queue.run_daily(
            calories_reminder_job,
            time=dtime(hour=22, minute=0, tzinfo=MOSCOW_TZ),
            name="calories_reminder_22",
        )

    return app


def main() -> None:
    ensure_csv_files()
    logger.info("Инициализация бота...")
    app = build_application()
    logger.info("Бот запущен (Polling)")
    app.run_polling()


if __name__ == "__main__":
    main()